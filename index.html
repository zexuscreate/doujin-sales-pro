<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="ãƒ¬ã‚¸ã‚ã">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0a0f">
<link rel="manifest" href="manifest.json">
<title>ãƒ¬ã‚¸ã‚ã</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Bebas+Neue&family=Space+Mono:wght@400;700&family=Zen+Maru+Gothic:wght@500;700&family=Dela+Gothic+One&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a0f;--bg2:#12121a;--bg3:#1a1a26;--card:#1e1e2e;--card2:#252538;
  --border:#2e2e45;--text:#e8e8f0;--text2:#9090b0;--text3:#5a5a7a;
  --accent:#7c6af7;--accent2:#5b4de0;--green:#4ade80;--red:#f87171;
  --yellow:#fbbf24;--cyan:#22d3ee;--pink:#f472b6;--r:12px;--rs:8px;
}
.light{--bg:#f0f0f8;--bg2:#e4e4f0;--bg3:#d8d8ec;--card:#fff;--card2:#f8f8ff;--border:#d0d0e8;--text:#1a1a2e;--text2:#4a4a6a;--text3:#8a8aaa;}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;font-size:14px;}

/* ---- LOGIN SCREEN ---- */
#loginScreen{
  display:none; /* JSã§è¡¨ç¤ºåˆ¶å¾¡ */
  position:fixed;inset:0;z-index:9999;
  background:var(--bg);
  flex-direction:column;align-items:center;justify-content:center;padding:30px;
}
#loginScreen.show{display:flex;}

/* ---- HEADER ---- */
.header{position:sticky;top:0;z-index:100;background:var(--bg2);border-bottom:1px solid var(--border);padding:10px 14px;display:flex;align-items:center;gap:10px;}
.htitle{font-family:'Bebas Neue',cursive;font-size:22px;letter-spacing:2px;color:var(--accent);flex:1;}
.ibt{width:34px;height:34px;border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:var(--rs);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:15px;transition:all .2s;}
.hbtn{height:34px;border:1px solid var(--border);background:var(--card);color:var(--text2);border-radius:var(--rs);cursor:pointer;padding:0 10px;font-size:12px;}

/* ---- NAV ---- */
.bnav{position:fixed;bottom:0;left:0;right:0;z-index:100;background:var(--bg2);border-top:1px solid var(--border);display:flex;padding-bottom:env(safe-area-inset-bottom);}
.ni{flex:1;padding:9px 4px 7px;display:flex;flex-direction:column;align-items:center;gap:2px;cursor:pointer;color:var(--text3);font-size:10px;transition:color .2s;background:none;border:none;}
.ni.active,.ni:focus{color:var(--accent);}
.ni .nico{font-size:19px;}

/* ---- LAYOUT ---- */
.mc{flex:1;padding:14px;padding-bottom:90px;overflow-y:auto;}
.page{display:none;}
.page.active{display:block;}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:14px;margin-bottom:10px;}
.ch{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.ct{font-weight:700;font-size:12px;color:var(--text2);letter-spacing:1px;text-transform:uppercase;}

/* ---- BUTTONS ---- */
.btn{padding:9px 18px;border-radius:var(--rs);border:none;cursor:pointer;font-family:'Noto Sans JP',sans-serif;font-weight:500;font-size:13px;transition:all .2s;display:inline-flex;align-items:center;gap:5px;}
.bp{background:var(--accent);color:#fff;}.bp:hover{background:var(--accent2);}
.bd{background:var(--red);color:#fff;}
.bs{background:var(--green);color:#000;}
.bg{background:transparent;color:var(--text2);border:1px solid var(--border);}
.bg:hover{background:var(--card2);}
.bsm{padding:5px 10px;font-size:11px;}
.bfull{width:100%;justify-content:center;padding:13px;}

/* ---- FORMS ---- */
.fg{margin-bottom:12px;}
.fl{display:block;font-size:11px;color:var(--text2);margin-bottom:5px;letter-spacing:.5px;}
.fi{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--rs);color:var(--text);padding:9px 11px;font-family:'Noto Sans JP',sans-serif;font-size:13px;transition:border-color .2s;}
.fi:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(124,106,247,.15);}

/* ---- TABS / TOGGLE ---- */
.tabs{display:flex;gap:3px;background:var(--bg3);padding:3px;border-radius:var(--rs);margin-bottom:14px;overflow-x:auto;scrollbar-width:none;}
.tabs::-webkit-scrollbar{display:none;}
.tab{flex:0 0 auto;padding:7px 10px;text-align:center;cursor:pointer;border-radius:6px;font-size:12px;color:var(--text2);transition:all .2s;border:none;background:none;white-space:nowrap;}
.tab.active{background:var(--card);color:var(--text);font-weight:700;}
.tog{display:flex;gap:3px;background:var(--bg3);padding:3px;border-radius:6px;}
.togb{padding:5px 8px;border-radius:4px;font-size:11px;cursor:pointer;border:none;background:transparent;color:var(--text2);transition:all .2s;white-space:nowrap;}
.togb.active{background:var(--accent);color:#fff;font-weight:700;}
.vtog{display:flex;gap:3px;}
.vb{width:30px;height:30px;border:1px solid var(--border);background:var(--card);color:var(--text2);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .2s;}
.vb.active{background:var(--accent);color:#fff;border-color:var(--accent);}

/* ---- EVENT CHIPS ---- */
.esel{display:flex;gap:7px;overflow-x:auto;padding-bottom:4px;margin-bottom:12px;scrollbar-width:none;}
.esel::-webkit-scrollbar{display:none;}
.echip{flex-shrink:0;padding:6px 13px;border-radius:20px;border:1px solid var(--border);background:var(--card);color:var(--text2);font-size:12px;cursor:pointer;transition:all .2s;white-space:nowrap;}
.echip.active{background:var(--accent);color:#fff;border-color:var(--accent);}

/* ---- PRODUCT TILES ---- */
.pgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
.ptile{aspect-ratio:2/3;border-radius:var(--rs);border:2px solid var(--border);overflow:hidden;cursor:pointer;position:relative;background:var(--card);transition:border-color .2s;user-select:none;}
.ptile:active{transform:scale(.98);}
.ptile.sel{border-color:var(--accent);}
.ptile.sout{opacity:.5;}
.cova{width:100%;height:68%;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--bg3),var(--card2));position:relative;overflow:hidden;}
.cova img{width:100%;height:100%;object-fit:cover;}
.cemoji{font-size:44px;}
.tinfo{padding:5px 7px;position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.72);}
.ttitle{font-size:11px;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tprice{font-size:12px;color:var(--accent);font-weight:700;font-family:'Space Mono',monospace;}
.tcnt{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:42px;font-weight:900;color:#fff;text-shadow:0 2px 12px rgba(0,0,0,.9);pointer-events:none;display:none;}
.tcnt.vis{display:block;}
.tstk{position:absolute;top:5px;right:5px;background:rgba(0,0,0,.65);color:var(--text2);font-size:10px;padding:2px 6px;border-radius:4px;}
.tstk.low{color:var(--yellow);}
.tstk.zero{color:var(--red);}
.solay{position:absolute;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;}
.solay.vis{display:flex;}
.sotxt{color:var(--red);font-weight:900;font-size:13px;letter-spacing:1px;border:2px solid var(--red);padding:3px 8px;border-radius:4px;transform:rotate(-15deg);}
.tplus{position:absolute;bottom:34px;right:6px;width:32px;height:32px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:900;color:#fff;cursor:pointer;z-index:2;border:none;}

/* ---- LIST VIEW ---- */
.pli{display:flex;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:var(--rs);padding:11px;margin-bottom:5px;transition:border-color .2s;}
.pli.sel{border-color:var(--accent);}
.lemi{font-size:20px;margin-right:10px;}
.lemi-img{width:32px;height:42px;margin-right:10px;flex-shrink:0;border-radius:4px;overflow:hidden;background:var(--bg3);}
.lemi-img img{width:100%;height:100%;object-fit:cover;}
.linf{flex:1;min-width:0;}
.ltit{font-size:13px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lpri{font-size:11px;color:var(--accent);font-family:'Space Mono',monospace;}
.lca{display:flex;align-items:center;gap:7px;}
.cdsp{font-size:17px;font-weight:700;min-width:28px;text-align:center;font-family:'Space Mono',monospace;}
.cbtn{width:28px;height:28px;border:none;border-radius:50%;cursor:pointer;font-size:16px;font-weight:700;display:flex;align-items:center;justify-content:center;}
.cbm{background:var(--red);color:#fff;}

/* ---- CHECKOUT BAR ---- */
.cob{position:fixed;bottom:56px;left:0;right:0;z-index:90;background:var(--bg2);border-top:1px solid var(--border);padding:9px 14px;}
.tod{display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;}
.tol{font-size:12px;color:var(--text2);}
.toa{font-size:22px;font-weight:900;font-family:'Space Mono',monospace;color:var(--text);}
.qcash{display:flex;gap:5px;margin-bottom:7px;}
.qcb{flex:1;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--card);color:var(--text2);font-size:11px;cursor:pointer;text-align:center;transition:all .2s;}
.qcb:hover{border-color:var(--accent);color:var(--accent);}
.chdsp{text-align:center;font-size:12px;color:var(--text2);margin-bottom:7px;min-height:18px;}
.cha{color:var(--yellow);font-weight:700;font-family:'Space Mono',monospace;}

/* ---- NUMPAD ---- */
.npo{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.75);display:none;align-items:flex-end;}
.npo.open{display:flex;}
.npp{width:100%;background:var(--bg2);border-top:1px solid var(--border);border-radius:20px 20px 0 0;padding:15px;padding-bottom:calc(15px + env(safe-area-inset-bottom));}
.nptit{text-align:center;font-size:12px;color:var(--text2);margin-bottom:7px;}
.npdsp{background:var(--bg3);border-radius:var(--rs);padding:11px;text-align:right;font-family:'Space Mono',monospace;font-size:26px;font-weight:700;color:var(--text);margin-bottom:11px;min-height:54px;}
.npgr{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;}
.npb{height:54px;background:var(--card);border:1px solid var(--border);border-radius:var(--rs);color:var(--text);font-size:20px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;transition:all .15s;}
.npb:active{background:var(--card2);transform:scale(.95);}
.npb.clr{background:var(--red);color:#fff;border-color:var(--red);font-size:14px;}
.npb.done{background:var(--green);color:#000;border-color:var(--green);font-size:14px;font-weight:900;}
.npq{display:grid;grid-template-columns:repeat(4,1fr);gap:5px;margin-bottom:9px;}
.npqb{padding:6px;border-radius:6px;background:var(--bg3);border:1px solid var(--border);color:var(--text2);font-size:11px;cursor:pointer;text-align:center;}

/* ---- MODAL ---- */
.mover{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;padding:14px;}
.mover.open{display:flex;}
.modal{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:22px;width:100%;max-width:480px;max-height:88vh;overflow-y:auto;}
.mtit{font-size:16px;font-weight:700;margin-bottom:7px;}
.msub{font-size:12px;color:var(--text2);margin-bottom:14px;}
.mact{display:flex;gap:7px;margin-top:14px;}
.mact .btn{flex:1;}

/* ---- STATS ---- */
.sgrid{display:grid;grid-template-columns:repeat(2,1fr);gap:7px;margin-bottom:11px;}
.stc{background:var(--card);border:1px solid var(--border);border-radius:var(--rs);padding:11px;}
.slb{font-size:10px;color:var(--text2);margin-bottom:3px;letter-spacing:.5px;}
.sv{font-size:19px;font-weight:700;font-family:'Space Mono',monospace;}
.sv.g{color:var(--green);}
.sv.c{color:var(--cyan);}
.sv.y{color:var(--yellow);}
.sv.pk{color:var(--pink);}

/* ---- CHARTS ---- */
.simch{width:100%;height:175px;margin:11px 0;}
.bebar{height:11px;background:var(--bg3);border-radius:6px;overflow:hidden;margin:7px 0;}
.befill{height:100%;border-radius:6px;transition:width .5s ease;background:linear-gradient(90deg,var(--red),var(--yellow),var(--green));}

/* ---- ANALYTICS mode buttons ---- */
.an-modes{display:flex;gap:4px;margin-bottom:10px;flex-wrap:wrap;}
.an-modes .togb{flex:1;min-width:80px;text-align:center;padding:6px 4px;}

/* ---- TOAST ---- */
.toast{position:fixed;top:68px;left:50%;transform:translateX(-50%);background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:9px 18px;font-size:13px;z-index:500;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;}

/* ---- HISTORY ---- */
.hitem{display:flex;align-items:center;padding:9px 0;border-bottom:1px solid var(--border);gap:9px;}
.htm{font-family:'Space Mono',monospace;font-size:11px;color:var(--text3);min-width:42px;}
.hinf{flex:1;}
.htitle2{font-size:13px;}
.hqty{font-size:11px;color:var(--text2);}
.hamt{font-family:'Space Mono',monospace;font-size:13px;color:var(--green);}

/* ---- MISC ---- */
.sdot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;}
.sdot.off{background:var(--red);}
.dold{color:var(--red);text-decoration:line-through;font-size:11px;}
.dnew{color:var(--green);font-weight:700;}
.empty{text-align:center;padding:36px 18px;color:var(--text3);}
.emico{font-size:44px;margin-bottom:11px;}
.lbadge{display:inline-flex;align-items:center;gap:3px;padding:3px 7px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:1px;cursor:pointer;}
.lbadge.lk{background:rgba(248,113,113,.2);color:var(--red);border:1px solid var(--red);}
.lbadge.ulk{background:rgba(74,222,128,.2);color:var(--green);border:1px solid var(--green);}

/* ---- PRODUCT MANAGE ---- */
.pmrow{background:var(--card);border:1px solid var(--border);border-radius:var(--rs);padding:12px;margin-bottom:8px;transition:opacity .3s;}
.pmrow.soldout-row{opacity:.45;}
.pmrow.soldout-row:hover{opacity:.7;}
.pmtop{display:flex;align-items:flex-start;gap:10px;margin-bottom:10px;}
.pm-img-btn{width:54px;height:72px;border-radius:6px;border:2px dashed var(--border);background:var(--bg3);cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:24px;position:relative;overflow:hidden;transition:border-color .2s;}
.pm-img-btn:hover{border-color:var(--accent);}
.pm-img-btn img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
.pm-img-lbl{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.6);font-size:8px;color:#fff;text-align:center;padding:2px 0;letter-spacing:.5px;}
.pmta{flex:1;min-width:0;}
.pmtinp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:7px 9px;font-size:14px;font-weight:700;font-family:'Noto Sans JP',sans-serif;}
.pmtinp:focus{outline:none;border-color:var(--accent);}
.pm-emoji-row{display:flex;align-items:center;gap:6px;margin-top:5px;}
.pm-emoji-inp{font-size:18px;width:36px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:3px 4px;color:var(--text);text-align:center;}
.pm-emoji-inp:focus{outline:none;border-color:var(--accent);}
.pm-sub{font-size:11px;color:var(--text2);}
.pmf{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:8px;}
.pmfi{background:var(--bg3);border-radius:6px;padding:6px 8px;}
.pmfl{font-size:9px;color:var(--text3);letter-spacing:.5px;margin-bottom:3px;}
.pmfv{display:flex;align-items:center;gap:2px;}
.pmfv span{font-size:11px;color:var(--text3);}
.pminp{width:100%;background:transparent;border:none;font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:var(--text);padding:0;outline:none;}
.pminp:focus{color:var(--accent);}
.pminp.ac{color:var(--accent);}
.pminp.cy{color:var(--cyan);}
.pminp.yw{color:var(--yellow);}

/* ---- ACCORDION ---- */
.acc{border:1px solid var(--border);border-radius:var(--rs);margin-bottom:6px;overflow:hidden;}
.acch{display:flex;align-items:center;justify-content:space-between;padding:9px 11px;cursor:pointer;background:var(--bg3);user-select:none;transition:background .2s;}
.acch:hover{background:var(--card2);}
.accl{font-size:11px;color:var(--text2);}
.acca{font-size:10px;color:var(--text3);transition:transform .25s;}
.acca.open{transform:rotate(180deg);}
.accb{display:none;padding:10px 11px;}
.accb.open{display:block;}
.erow{display:flex;align-items:center;gap:6px;padding:5px 0;border-bottom:1px solid var(--border);}
.erow:last-of-type{border-bottom:none;}
.erinp{background:var(--bg3);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:4px 6px;font-size:12px;font-family:'Space Mono',monospace;}
.erinp:focus{outline:none;border-color:var(--accent);}
.erinp.lbl{min-width:55px;max-width:80px;color:var(--text2);}
.erinp.num{width:70px;text-align:right;}
.erinp.amt{width:85px;text-align:right;color:var(--accent);}
.erdel{background:none;border:none;cursor:pointer;color:var(--red);font-size:13px;padding:2px 5px;border-radius:4px;flex-shrink:0;}
.erdel:hover{background:rgba(248,113,113,.1);}
.cged{display:flex;flex-direction:column;gap:6px;}
.cg-row{display:flex;align-items:center;gap:6px;padding:5px 0;border-bottom:1px solid var(--border);}
.cg-row:last-of-type{border-bottom:none;}
.cg-name-inp{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:5px;color:var(--text);padding:4px 7px;font-size:12px;font-family:'Noto Sans JP',sans-serif;}
.cg-name-inp:focus{outline:none;border-color:var(--accent);}
.cg-amt-inp{width:85px;background:var(--bg3);border:1px solid var(--border);border-radius:5px;color:var(--accent);padding:4px 6px;font-size:12px;font-family:'Space Mono',monospace;text-align:right;}
.cg-amt-inp:focus{outline:none;border-color:var(--accent);}

/* ---- EVENT PRODUCT CHECK ---- */
.eplist{display:flex;flex-direction:column;gap:5px;}
.epitem{display:flex;align-items:center;gap:10px;padding:8px 10px;background:var(--bg3);border-radius:var(--rs);cursor:pointer;border:1px solid transparent;transition:all .2s;}
.epitem.chk{border-color:var(--accent);background:rgba(124,106,247,.1);}
.epbox{width:20px;height:20px;border-radius:5px;border:2px solid var(--border);background:var(--bg);display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;}
.epitem.chk .epbox{background:var(--accent);border-color:var(--accent);}

/* ---- IMAGE DROP ---- */
.idover{position:fixed;inset:0;z-index:400;background:rgba(0,0,0,.92);display:none;flex-direction:column;align-items:center;justify-content:center;gap:14px;padding:20px;}
.idover.open{display:flex;}
.idzone{width:100%;max-width:340px;min-height:180px;border:2px dashed var(--border);border-radius:var(--r);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:20px;cursor:pointer;position:relative;transition:all .2s;background:var(--bg2);}
.idzone.drag{border-color:var(--accent);background:rgba(124,106,247,.1);}
.idzone input{position:absolute;inset:0;opacity:0;cursor:pointer;font-size:0;}
.idprev{max-width:200px;max-height:200px;border-radius:var(--rs);object-fit:contain;display:none;}
.idprev.vis{display:block;}

/* ---- ANALYTICS ---- */
.prod-checks{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
.pchk{display:flex;align-items:center;gap:5px;padding:4px 9px;border-radius:20px;border:1px solid var(--border);cursor:pointer;font-size:11px;transition:all .2s;user-select:none;}
.pchk.on{border-color:var(--accent);background:rgba(124,106,247,.12);}
.pchk-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}

/* ---- SIM TABLE ---- */
.betable{width:100%;border-collapse:collapse;font-size:11px;margin-top:10px;}
.betable th{background:var(--bg3);color:var(--text2);padding:5px 8px;text-align:right;font-weight:600;border-bottom:1px solid var(--border);}
.betable th:first-child{text-align:left;}
.betable td{padding:5px 8px;text-align:right;border-bottom:1px solid var(--border);font-family:'Space Mono',monospace;font-size:11px;}
.betable td:first-child{text-align:left;font-family:'Noto Sans JP',sans-serif;}
.betable tr.be-row{background:rgba(251,191,36,.08);}
.betable tr.profit td{color:var(--green);}
.betable tr.loss td{color:var(--red);}
.betable tr.profit td:first-child,.betable tr.loss td:first-child{color:var(--text);}
.sim-ev-sel{display:flex;gap:7px;overflow-x:auto;padding-bottom:4px;margin-bottom:10px;scrollbar-width:none;}
.sim-ev-sel::-webkit-scrollbar{display:none;}

/* ---- DATALIST DROPDOWN ---- */
.ddwrap{position:relative;display:flex;align-items:center;}
.ddwrap input{flex:1;padding-right:30px;}
.ddbtn{position:absolute;right:2px;top:50%;transform:translateY(-50%);width:26px;height:26px;border:none;background:none;color:var(--text3);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;border-radius:4px;z-index:1;}
.ddbtn:hover{background:var(--bg3);}

/* ---- SCROLLBAR ---- */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-track{background:var(--bg2);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* ---- RESPONSIVE ---- */
@media(min-width:768px){
  .mc{max-width:820px;margin:0 auto;}
  .pgrid{grid-template-columns:repeat(3,1fr);}
  .sgrid{grid-template-columns:repeat(4,1fr);}
  .bnav,.cob{max-width:820px;left:50%;transform:translateX(-50%);border-left:1px solid var(--border);border-right:1px solid var(--border);}
}
</style>
</head>
<body>

<!-- ================================================================ LOGIN SCREEN -->
<div id="loginScreen">
  <div style="font-family:'Dela Gothic One',cursive;font-size:44px;letter-spacing:5px;background:linear-gradient(135deg,#7c6af7,#22d3ee);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px;">ãƒ¬ã‚¸ã‚ã</div>
  <div style="font-family:'Zen Maru Gothic',sans-serif;font-size:13px;color:var(--text2);margin-bottom:32px;letter-spacing:2px;">åŒäººèªŒãƒ¬ã‚¸ï¼†å£²ä¸Šè¨˜éŒ²ã‚¢ãƒ—ãƒª</div>
  <div style="width:100%;max-width:340px;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;">
    <div id="loginErr" style="display:none;background:rgba(248,113,113,.15);border:1px solid var(--red);border-radius:8px;padding:10px;margin-bottom:14px;font-size:12px;color:var(--red);"></div>

    <!-- ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ (ä¸€ç•ªç›®ç«‹ã¤) -->
    <button onclick="startGuestMode()" style="width:100%;padding:14px;background:var(--accent);color:#fff;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;margin-bottom:10px;letter-spacing:1px;">
      ğŸš€ ã™ãã«ä½¿ã†ï¼ˆã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼‰
    </button>
    <div style="font-size:11px;color:var(--text3);text-align:center;margin-bottom:18px;">ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™</div>

    <!-- ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ¢ãƒ¼ãƒ‰ -->
    <button onclick="startLocalSavedMode()" style="width:100%;padding:11px;background:var(--bg3);color:var(--text);border:1px solid var(--border);border-radius:10px;font-size:13px;cursor:pointer;margin-bottom:20px;">
      ğŸ’¾ ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ¢ãƒ¼ãƒ‰ï¼ˆã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ï¼‰
    </button>

    <!-- åŒºåˆ‡ã‚Š -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
      <div style="flex:1;height:1px;background:var(--border);"></div>
      <span style="font-size:11px;color:var(--text3);">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼‰</span>
      <div style="flex:1;height:1px;background:var(--border);"></div>
    </div>

    <!-- Google ãƒ­ã‚°ã‚¤ãƒ³ -->
    <button id="googleLoginBtn" onclick="tryLoginWithGoogle()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:10px;padding:12px;background:#fff;color:#333;border:1px solid #ddd;border-radius:10px;font-size:13px;font-weight:500;cursor:pointer;margin-bottom:14px;">
      <svg width="16" height="16" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.08 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.36-8.16 2.36-6.26 0-11.57-3.59-13.46-8.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
      Googleã§ãƒ­ã‚°ã‚¤ãƒ³
    </button>

    <!-- ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ -->
    <div style="display:flex;border-radius:8px;overflow:hidden;border:1px solid var(--border);margin-bottom:14px;">
      <button id="tabLogin" onclick="switchAuthTab('login')" style="flex:1;padding:8px;font-size:12px;cursor:pointer;border:none;background:var(--accent);color:#fff;">ãƒ­ã‚°ã‚¤ãƒ³</button>
      <button id="tabSignup" onclick="switchAuthTab('signup')" style="flex:1;padding:8px;font-size:12px;cursor:pointer;border:none;background:transparent;color:var(--text2);">æ–°è¦ç™»éŒ²</button>
    </div>
    <input class="fi" id="authEmail" type="email" placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹" style="margin-bottom:8px;">
    <input class="fi" id="authPass" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="margin-bottom:12px;">
    <button id="authSubmitBtn" onclick="trySubmitAuth()" style="width:100%;padding:11px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;margin-bottom:8px;">ãƒ­ã‚°ã‚¤ãƒ³</button>
    <div id="forgotArea" style="text-align:center;"><button onclick="tryResetPassword()" style="background:none;border:none;color:var(--text3);font-size:11px;cursor:pointer;text-decoration:underline;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸ</button></div>
  </div>
</div>

<!-- NUMPAD -->
<div class="npo" id="npo">
  <div class="npp">
    <div class="nptit" id="npTit">é‡‘é¡ã‚’å…¥åŠ›</div>
    <div class="npdsp" id="npDsp">0</div>
    <div class="npq" id="npQ"></div>
    <div class="npgr">
      <button class="npb" onclick="npi('7')">7</button><button class="npb" onclick="npi('8')">8</button><button class="npb" onclick="npi('9')">9</button>
      <button class="npb" onclick="npi('4')">4</button><button class="npb" onclick="npi('5')">5</button><button class="npb" onclick="npi('6')">6</button>
      <button class="npb" onclick="npi('1')">1</button><button class="npb" onclick="npi('2')">2</button><button class="npb" onclick="npi('3')">3</button>
      <button class="npb" onclick="npi('0')">0</button><button class="npb" onclick="npi('00')">00</button><button class="npb clr" onclick="npc()">C</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:9px;">
      <button class="npb" style="height:46px;font-size:13px;" onclick="closeNP()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="npb done" style="height:46px;" onclick="npDone()">æ±ºå®š</button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="mover" id="mover"><div class="modal" id="mcont"></div></div>
<div class="toast" id="toast"></div>
<input type="file" id="csvFI" accept=".csv" style="display:none" onchange="handleCSVFile(event)">

<script>
// ================================================================ STATE
var S={theme:'dark',vm:'card',page:'register',evId:null,anEvId:null,anMode:'cost',simIdx:0,simMode:'cost',simEvId:null,yAxisSet:null,showSimpleUC:true,cart:{},pp:0,npTarget:null,npCb:null};
var npVal='0',simOvr={},csvTarget=null;
var openAcc=new Set();
var anProdFilter=null;
var imgPid=null,imgDataUrl=null;

// ================================================================ HELPERS
function uid(){return Math.random().toString(36).substr(2,9);}
function totOrd(p){return(p.editions||[]).reduce(function(s,e){return s+(e.ordered||0);},0);}
function totCost(p){
  return(p.costs||[]).reduce(function(s,c){
    if(c.perEdition&&Object.keys(c.perEdition).length>0){
      return s+Object.values(c.perEdition).reduce(function(a,v){return a+(v||0);},0);
    }
    return s+(c.amount||0);
  },0);
}
function unitCost(p){var o=totOrd(p);return o>0?Math.round(totCost(p)/o):0;}
function evProds(eid){var ev=S.e.find(function(e){return e.id===eid;});if(!ev)return[];return S.p.filter(function(p){return(ev.productIds||[]).includes(p.id);});}
var PCOLS=['#7c6af7','#22d3ee','#4ade80','#fbbf24','#f472b6','#f87171','#60a5fa','#a78bfa'];
function pCol(i){return PCOLS[i%PCOLS.length];}

// ================================================================ SAMPLE DATA
function initSample(){
  var ev={id:uid(),name:'ä¾‹ï¼šã‚³ãƒŸã‚±',date:'2026-05-05',expenses:[{id:uid(),name:'å‚åŠ è²»',amount:8000},{id:uid(),name:'äº¤é€šè²»',amount:2000}],isLocked:false,productIds:[]};
  function mkP(title,emoji,price,shopPrice,stock,ordAmt,costName){
    var eid1=uid();
    return{id:uid(),title:title,emoji:emoji,price:price,shopPrice:shopPrice,stock:stock,sortNum:0,coverImg:null,
      editions:[{id:eid1,label:'ç¬¬1ç‰ˆ',ordered:ordAmt}],
      costs:[{id:uid(),name:costName,amount:0,perEdition:{[eid1]:0}}]};
  }
  var p1=mkP('ä¾‹1:æ–°åˆŠ','ğŸ“•',1000,800,100,100,'å°åˆ·è²»');p1.sortNum=1;
  p1.costs[0].amount=40000;p1.costs[0].perEdition[p1.editions[0].id]=40000;
  var p2=mkP('ä¾‹2:æ—¢åˆŠ','ğŸ“˜',700,600,50,50,'å°åˆ·è²»');p2.sortNum=2;
  p2.costs[0].amount=20000;p2.costs[0].perEdition[p2.editions[0].id]=20000;
  var p3=mkP('ä¾‹3:ã‚°ãƒƒã‚º','ğŸ',500,450,80,80,'è£½ä½œè²»');p3.sortNum=3;
  p3.costs[0].amount=15000;p3.costs[0].perEdition[p3.editions[0].id]=15000;
  ev.productIds=[p1.id];
  S.e=[ev];S.p=[p1,p2,p3];S.s=[];
  S.evId=ev.id;S.anEvId=ev.id;S.simEvId=ev.id;
  var sd=[{pid:p1.id,qty:3,t:'10:15'},{pid:p2.id,qty:2,t:'10:22'},{pid:p1.id,qty:5,t:'10:45'},
    {pid:p3.id,qty:4,t:'11:00'},{pid:p1.id,qty:8,t:'11:30'},{pid:p2.id,qty:3,t:'11:45'},
    {pid:p3.id,qty:6,t:'12:00'},{pid:p1.id,qty:4,t:'12:30'},{pid:p2.id,qty:5,t:'13:00'}];
  sd.forEach(function(x){
    var pr=S.p.find(function(pp){return pp.id===x.pid;});
    S.s.push({id:uid(),eid:ev.id,pid:x.pid,qty:x.qty,price:pr.price,ts:new Date('2026-05-05T'+x.t+':00').toISOString()});
  });
  save();
}

// ================================================================ STORAGE
function save(){
  if(appMode==='guest')return;
  var key=localStorage.getItem('djp_user_key')||'djp_v4_local';
  try{localStorage.setItem(key,JSON.stringify({p:S.p,e:S.e,s:S.s,theme:S.theme}));}catch(x){}
}
function loadData(key){
  try{
    var d=JSON.parse(localStorage.getItem(key)||'null');
    if(d){S.p=d.p||[];S.e=d.e||[];S.s=d.s||[];S.theme=d.theme||'dark';}
    else{S.p=[];S.e=[];S.s=[];initSample();}
  }catch(e){S.p=[];S.e=[];S.s=[];initSample();}
}

// ================================================================ THEME
function toggleTheme(){
  S.theme=S.theme==='dark'?'light':'dark';
  document.body.className=S.theme==='light'?'light':'';
  document.getElementById('themeBtn').textContent=S.theme==='dark'?'â˜€ï¸':'ğŸŒ™';
  save();
}

// ================================================================ NAV
function showPage(pg){
  S.page=pg;openAcc.clear();
  document.querySelectorAll('.page').forEach(function(x){x.classList.remove('active');});
  document.querySelectorAll('.ni').forEach(function(x){x.classList.remove('active');});
  document.getElementById('page-'+pg).classList.add('active');
  document.querySelector('[data-page="'+pg+'"]').classList.add('active');
  renderPage();
}
function renderPage(){
  switch(S.page){
    case 'register':renderReg();break;
    case 'products':renderPM();break;
    case 'events':renderEV();break;
    case 'analytics':renderAN();break;
    case 'sim':renderSIM();break;
  }
}

// ================================================================ REGISTER
function setVM(m){
  S.vm=m;
  document.getElementById('vbCard').classList.toggle('active',m==='card');
  document.getElementById('vbList').classList.toggle('active',m==='list');
  renderProdDisp();
}
function renderReg(){renderEvSel();renderProdDisp();updateCart();}
function renderEvSel(){
  var el=document.getElementById('evSel');
  if(!S.e||!S.e.length){el.innerHTML='<div style="font-size:12px;color:var(--text3);">ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';return;}
  if(!S.evId)S.evId=S.e[0].id;
  el.innerHTML=S.e.map(function(e){return '<div class="echip '+(e.id===S.evId?'active':'')+'" onclick="selEv(\''+e.id+'\')">'+e.name+'</div>';}).join('');
  var ev=S.e.find(function(e){return e.id===S.evId;});
  document.getElementById('regEvName').textContent=ev?ev.name+' ã®é ’å¸ƒå•†å“':'';
}
function selEv(id){S.evId=id;S.cart={};renderReg();}
function renderProdDisp(){
  var el=document.getElementById('prodDisp');
  var prods=S.evId?evProds(S.evId):S.p;
  if(!prods||!prods.length){el.innerHTML='<div class="empty"><div class="emico">ğŸ“¦</div><div>ã“ã®ã‚¤ãƒ™ãƒ³ãƒˆã«å•†å“ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br><small>ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†ã‹ã‚‰å•†å“ã‚’å‰²ã‚Šå½“ã¦ã¦ãã ã•ã„</small></div></div>';return;}
  prods=prods.slice().sort(function(a,b){return (a.sortNum||9999)-(b.sortNum||9999);});
  el.innerHTML=S.vm==='card'?'<div class="pgrid">'+prods.map(renderPCard).join('')+'</div>':prods.map(renderPList).join('');
}
function renderPCard(p){
  var cnt=S.cart[p.id]||0,z=p.stock<=0,lw=p.stock>0&&p.stock<=5;
  var cov=p.coverImg?'<img src="'+p.coverImg+'">':`<div class="cemoji">${p.emoji||'ğŸ“–'}</div>`;
  return '<div class="ptile '+(cnt>0?'sel':'')+' '+(z?'sout':'')+'" id="pt-'+p.id+'" '+(z?'':'onclick="addC(\''+p.id+'\',event)"')+'>'
    +'<div class="cova">'+cov+'</div>'
    +'<div class="tinfo"><div class="ttitle">'+p.title+'</div><div class="tprice">Â¥'+p.price.toLocaleString()+'</div></div>'
    +'<div class="tcnt '+(cnt>0?'vis':'')+'" id="tc-'+p.id+'">'+cnt+'</div>'
    +'<div class="tstk '+(z?'zero':lw?'low':'')+'">'+( z?'å®Œå£²':'æ®‹'+p.stock)+'</div>'
    +'<div class="solay '+(z?'vis':'')+'"><div class="sotxt">SOLD OUT</div></div>'
    +(cnt>0?'<button class="tplus" onclick="rmC(\''+p.id+'\',event)">âˆ’</button>':'')
    +'</div>';
}
function renderPList(p){
  var cnt=S.cart[p.id]||0,z=p.stock<=0;
  var liImg=p.coverImg
    ?'<div class="lemi-img"><img src="'+p.coverImg+'"></div>'
    :'<div class="lemi">'+(p.emoji||'ğŸ“–')+'</div>';
  return '<div class="pli '+(cnt>0?'sel':'')+' '+(z?'sout':'')+'" '+(z?'':'onclick="addC(\''+p.id+'\',event)"')+' style="cursor:'+(z?'default':'pointer')+';">'
    +liImg
    +'<div class="linf"><div class="ltit">'+p.title+'</div><div class="lpri">Â¥'+p.price.toLocaleString()+' / æ®‹'+p.stock+'éƒ¨</div></div>'
    +'<div class="lca" onclick="event.stopPropagation()">'
    +'<div class="cdsp">'+cnt+'</div>'
    +(cnt>0?'<button class="cbtn cbm" onclick="rmC(\''+p.id+'\',event)">âˆ’</button>':'<div style="width:28px;"></div>')
    +'</div></div>';
}
function addC(pid,ev){ev&&ev.stopPropagation();var p=S.p.find(function(x){return x.id===pid;});if(!p||p.stock<=0)return;var c=S.cart[pid]||0;if(c>=p.stock){showToast('åœ¨åº«ä¸è¶³');return;}S.cart[pid]=c+1;updateCart();renderProdDisp();}
function rmC(pid,ev){ev&&ev.stopPropagation();var c=S.cart[pid]||0;if(c<=0)return;S.cart[pid]=c-1;if(!S.cart[pid])delete S.cart[pid];updateCart();renderProdDisp();}
function updateCart(){
  var t=0;Object.entries(S.cart).forEach(function(e){var p=S.p.find(function(x){return x.id===e[0];});if(p)t+=p.price*e[1];});
  document.getElementById('totAmt').textContent='Â¥'+t.toLocaleString();updCh(t);
}
function updCh(t){
  var el=document.getElementById('chDisp');
  if(S.pp>0){var c=S.pp-t;el.innerHTML='ãŠé‡£ã‚Š: <span class="cha">'+(c>=0?'Â¥'+c.toLocaleString():'ä¸è¶³ Â¥'+Math.abs(c).toLocaleString())+'</span>';}
  else el.innerHTML='ãŠé‡£ã‚Š: <span class="cha">-</span>';
}
function setPP(a){S.pp=a;var t=Object.entries(S.cart).reduce(function(s,e){var p=S.p.find(function(x){return x.id===e[0];});return s+(p?p.price*e[1]:0);},0);updCh(t);}
function resetCart(){S.cart={};S.pp=0;renderProdDisp();updateCart();}
function confirmSale(){
  var items=Object.entries(S.cart).filter(function(e){return e[1]>0;});
  if(!items.length){showToast('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  if(!S.evId){showToast('ã‚¤ãƒ™ãƒ³ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
  var ev=S.e.find(function(e){return e.id===S.evId;});if(ev&&ev.isLocked){showToast('ãƒ­ãƒƒã‚¯ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆã§ã™');return;}
  var t=items.reduce(function(s,e){var p=S.p.find(function(x){return x.id===e[0];});return s+(p?p.price*e[1]:0);},0);
  var lines=items.map(function(e){var p=S.p.find(function(x){return x.id===e[0];});return '<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);"><span>'+p.title+' Ã— '+e[1]+'</span><span style="color:var(--green);">Â¥'+(p.price*e[1]).toLocaleString()+'</span></div>';}).join('');
  openM('<div class="mtit">ä¼šè¨ˆç¢ºèª</div><div class="msub">ä»¥ä¸‹ã®å†…å®¹ã§ç¢ºå®šã—ã¾ã™</div>'+lines
    +'<div style="display:flex;justify-content:space-between;padding:10px 0;font-size:16px;font-weight:700;"><span>åˆè¨ˆ</span><span style="color:var(--green);">Â¥'+t.toLocaleString()+'</span></div>'
    +(S.pp>0?'<div style="text-align:center;font-size:13px;color:var(--yellow);">ãŠé‡£ã‚Š: Â¥'+(S.pp-t).toLocaleString()+'</div>':'')
    +'<div class="mact"><button class="btn bg" onclick="closeM()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn bs" onclick="execSale()">ç¢ºå®šã™ã‚‹</button></div>');
}
function execSale(){
  var now=new Date().toISOString();
  Object.entries(S.cart).forEach(function(e){if(!e[1])return;var p=S.p.find(function(x){return x.id===e[0];});if(!p)return;S.s.push({id:uid(),eid:S.evId,pid:e[0],qty:e[1],price:p.price,ts:now});p.stock=Math.max(0,p.stock-e[1]);});
  save();closeM();resetCart();renderProdDisp();showToast('âœ… ä¼šè¨ˆå®Œäº†ï¼');
}

// ================================================================ PRODUCT MANAGE
function renderPM(){
  var el=document.getElementById('pmList');
  if(!S.p||!S.p.length){el.innerHTML='<div class="empty"><div class="emico">ğŸ“¦</div><div>å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div></div>';return;}
  var sorted=S.p.slice().sort(function(a,b){
    var az=a.stock<=0,bz=b.stock<=0;
    if(az!==bz)return az?1:-1;
    return (a.sortNum||9999)-(b.sortNum||9999);
  });
  el.innerHTML=sorted.map(renderPMRow).join('');
  restoreAcc();
}
function renderPMRow(p){
  var ord=totOrd(p),uc=unitCost(p);
  var sold=S.s.filter(function(s){return s.pid===p.id;}).reduce(function(a,x){return a+x.qty;},0);
  var isSoldOut=p.stock<=0;
  var cov=p.coverImg?'<img src="'+p.coverImg+'">':`<span style="font-size:24px;">${p.emoji||'ğŸ“–'}</span>`;
  var eds=p.editions||[];
  var edRows=eds.map(function(ed){
    var edCost=(p.costs||[]).reduce(function(s,c){return s+(c.perEdition&&c.perEdition[ed.id]?c.perEdition[ed.id]:0);},0);
    var edUC=ed.ordered>0?edCost/ed.ordered:0;
    var costRows=(p.costs||[]).map(function(c){
      var val=c.perEdition&&c.perEdition[ed.id]!==undefined?c.perEdition[ed.id]:c.amount;
      return '<div class="cg-row">'
        +'<div class="ddwrap" style="flex:1;">'
        +'<input class="cg-name-inp" id="cn-nm-'+p.id+'-'+ed.id+'-'+c.id+'" list="cnl-'+p.id+'-'+ed.id+'-'+c.id+'" value="'+c.name.replace(/"/g,'&quot;')+'" onchange="updCostName(\''+p.id+'\',\''+c.id+'\',this.value)" onclick="event.stopPropagation();this.select()">'
        +'<datalist id="cnl-'+p.id+'-'+ed.id+'-'+c.id+'"><option value="å°åˆ·è²»"><option value="å£²å­è²»"><option value="è£½ä½œè²»"><option value="äº¤é€šè²»"><option value="å‚åŠ è²»"></datalist>'
        +'<button class="ddbtn" onclick="event.stopPropagation();showDD(\'cn-nm-'+p.id+'-'+ed.id+'-'+c.id+'\')" tabindex="-1">â–¼</button>'
        +'</div>'
        +'<input class="cg-amt-inp" type="number" min="0" value="'+val+'" onchange="updCostEdAmt(\''+p.id+'\',\''+c.id+'\',\''+ed.id+'\',this.value)" onclick="event.stopPropagation();this.select()">'
        +'<span style="font-size:11px;color:var(--text3);">å††</span>'
        +'<button class="erdel" onclick="event.stopPropagation();delCostSafe(\''+p.id+'\',\''+c.id+'\')">âœ•</button>'
        +'</div>';
    }).join('');
    var cAccId='acc-cost-'+p.id+'-'+ed.id;
    var adjUCVal=(ed.adjUnitCost!=null&&ed.adjUnitCost>=0)?ed.adjUnitCost:null;
    var simpleUCStr=(edUC).toFixed(1);
    return '<div style="background:var(--bg3);border:1px solid var(--border);border-radius:6px;margin-bottom:5px;overflow:hidden;">'
      +'<div style="display:flex;align-items:center;gap:5px;padding:7px 9px;flex-wrap:wrap;">'
      +'<input class="erinp lbl" value="'+ed.label.replace(/"/g,'&quot;')+'" onchange="updEdLbl(\''+p.id+'\',\''+ed.id+'\',this.value)" onclick="event.stopPropagation();this.select()">'
      +'<input class="erinp num" type="number" min="0" value="'+ed.ordered+'" onchange="updEd(\''+p.id+'\',\''+ed.id+'\',this.value)" onclick="event.stopPropagation();this.select()">'
      +'<span style="font-size:9px;color:var(--text3);">éƒ¨</span>'
      +(S.showSimpleUC?'<span style="font-size:9px;color:var(--text2);white-space:nowrap;" id="uc-'+p.id+'-'+ed.id+'">å˜ç´”Â¥'+simpleUCStr+'/éƒ¨</span>':'<span id="uc-'+p.id+'-'+ed.id+'" style="display:none;"></span>')
      +'<span style="font-size:11px;color:var(--yellow);font-family:\'Space Mono\';white-space:nowrap;" id="ec-'+p.id+'-'+ed.id+'">Â¥'+edCost.toLocaleString()+'</span>'
      +(adjUCVal!==null?'<span style="font-size:10px;color:var(--accent);font-weight:700;white-space:nowrap;">èª¿æ•´Â¥'+adjUCVal+'/éƒ¨</span>':'')
      +'<button class="btn bg" style="padding:5px 8px;font-size:10px;" onclick="event.stopPropagation();togAcc(\''+cAccId+'\')">ğŸ’° åŸä¾¡</button>'
      +'<button class="btn bg" style="padding:5px 8px;font-size:10px;" onclick="event.stopPropagation();openAdjUC(\''+p.id+'\',\''+ed.id+'\')">' + (adjUCVal!==null?'èª¿æ•´æ¸ˆã¿':'èª¿æ•´åŸä¾¡') +'</button>'
      +'<button class="erdel" onclick="event.stopPropagation();delEdSafe(\''+p.id+'\',\''+ed.id+'\')">âœ•</button>'
      +'</div>'
      +'<div class="accb '+(openAcc.has(cAccId)?'open':'')+'" id="'+cAccId+'" style="padding:8px 9px;border-top:1px solid var(--border);background:var(--bg2);">'
      +'<div class="cged">'+(costRows||'<div style="font-size:11px;color:var(--text3);">åŸä¾¡é …ç›®ãªã—</div>')+'</div>'
      +'<div style="display:flex;gap:5px;margin-top:7px;align-items:flex-end;">'
      +'<div style="flex:1;"><div style="font-size:9px;color:var(--text3);margin-bottom:2px;">é …ç›®å</div>'
      +'<div class="ddwrap"><input class="fi" id="cn-'+p.id+'-'+ed.id+'" list="cnlist-'+p.id+'-'+ed.id+'" placeholder="å°åˆ·è²»ãªã©" style="font-size:12px;padding:5px 7px;padding-right:30px;">'
      +'<datalist id="cnlist-'+p.id+'-'+ed.id+'"><option value="å°åˆ·è²»"><option value="å£²å­è²»"><option value="è£½ä½œè²»"><option value="äº¤é€šè²»"><option value="å‚åŠ è²»"></datalist>'
      +'<button class="ddbtn" onclick="event.stopPropagation();showDD(\'cn-'+p.id+'-'+ed.id+'\')" tabindex="-1">â–¼</button></div></div>'
      +'<div style="width:85px;"><div style="font-size:9px;color:var(--text3);margin-bottom:2px;">é‡‘é¡</div><input class="fi" id="ca-'+p.id+'-'+ed.id+'" type="number" min="0" placeholder="0" style="font-size:12px;padding:5px 7px;"></div>'
      +'<button class="btn bp bsm" onclick="addCostForEd(\''+p.id+'\',\''+ed.id+'\')">è¿½åŠ </button>'
      +'</div></div></div>';
  }).join('');
  return '<div class="pmrow '+(isSoldOut?'soldout-row':'')+'" id="pmr-'+p.id+'">'
    +'<div class="pmtop">'
    +'<button class="pm-img-btn" onclick="openImgDrop(\''+p.id+'\')" title="ã‚¯ãƒªãƒƒã‚¯ã—ã¦ç”»åƒã‚’å¤‰æ›´">'+cov+'<span class="pm-img-lbl">IMG</span></button>'
    +'<div class="pmta">'
    +'<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">'
    +'<div style="display:flex;align-items:center;gap:3px;flex-shrink:0;"><span style="font-size:9px;color:var(--text3);">No.</span>'
    +'<input class="pminp" type="number" min="1" value="'+(p.sortNum||'')+'" style="width:38px;font-size:12px;font-weight:700;color:var(--cyan);text-align:center;background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:2px 3px;" onchange="updProdNum(\''+p.id+'\',\'sortNum\',this.value);setTimeout(()=>renderPM(),150);" onclick="this.select()"></div>'
    +'<input class="pmtinp" style="flex:1;" value="'+p.title.replace(/"/g,'&quot;')+'" onblur="updProdField(\''+p.id+'\',\'title\',this.value)" onkeydown="if(event.key===\'Enter\')this.blur();">'
    +'</div>'
    +'<div class="pm-emoji-row">'
    +'<input class="pm-emoji-inp" value="'+(p.emoji||'ğŸ“–')+'" onblur="updProdField(\''+p.id+'\',\'emoji\',this.value)" onkeydown="if(event.key===\'Enter\')this.blur();">'
    +'<span class="pm-sub">â† çµµæ–‡å­— / é ’å¸ƒ: '+sold+'éƒ¨ '+(isSoldOut?'<span style="color:var(--red);font-size:10px;">â— å®Œå£²</span>':'')+'</span>'
    +'</div></div></div>'
    +'<div class="pmf">'
    +'<div class="pmfi"><div class="pmfl">ã‚¤ãƒ™ãƒ³ãƒˆä¾¡æ ¼</div><div class="pmfv"><span>Â¥</span><input class="pminp ac" type="number" min="0" value="'+p.price+'" onchange="updProdNum(\''+p.id+'\',\'price\',this.value)" onclick="this.select()"></div></div>'
    +'<div class="pmfi"><div class="pmfl">æ›¸åº—ä¾¡æ ¼</div><div class="pmfv"><span>Â¥</span><input class="pminp cy" type="number" min="0" value="'+p.shopPrice+'" onchange="updProdNum(\''+p.id+'\',\'shopPrice\',this.value)" onclick="this.select()"></div></div>'
    +'<div class="pmfi"><div class="pmfl">åœ¨åº«</div><div class="pmfv"><input class="pminp yw" type="number" min="0" value="'+p.stock+'" onchange="updProdNum(\''+p.id+'\',\'stock\',this.value)" onclick="this.select()"><span>éƒ¨</span></div></div>'
    +'</div>'
    +'<div class="acc">'
    +'<div class="acch" onclick="togAcc(\'acc-ed-'+p.id+'\')">'
    +'<span class="accl">ğŸ“š ç™ºè¡Œç‰ˆæ•° (åˆè¨ˆ: '+ord+'éƒ¨ / åŸä¾¡/éƒ¨: Â¥'+Math.round(uc).toLocaleString()+')</span>'
    +'<span class="acca '+(openAcc.has('acc-ed-'+p.id)?'open':'')+'" id="aa-acc-ed-'+p.id+'">â–¼</span>'
    +'</div>'
    +'<div class="accb '+(openAcc.has('acc-ed-'+p.id)?'open':'')+'" id="acc-ed-'+p.id+'">'
    +(edRows||'<div style="font-size:12px;color:var(--text3);">ç‰ˆãŒã‚ã‚Šã¾ã›ã‚“</div>')
    +'<button class="btn bg bsm" style="margin-top:4px;" onclick="addEd(\''+p.id+'\')">ï¼‹ ç‰ˆã‚’è¿½åŠ </button>'
    +'</div></div>'
    +'<div style="display:flex;gap:5px;flex-wrap:wrap;margin-top:9px;">'
    +'<button class="btn bg bsm" onclick="openAddStock(\''+p.id+'\')">ğŸ“¦ åœ¨åº«è¿½åŠ </button>'
    +(p.coverImg?'<button class="btn bg bsm" onclick="rmImg(\''+p.id+'\')">ğŸ—‘ ç”»åƒå‰Šé™¤</button>':'')
    +'<button class="btn bd bsm" style="margin-left:auto;" onclick="delProd(\''+p.id+'\')">ğŸ—‘ å‰Šé™¤</button>'
    +'</div></div>';
}
// ================================================================ èª¿æ•´åŸä¾¡
function edAdjUC(p,ed){
  if(ed.adjUnitCost!=null&&ed.adjUnitCost>=0)return ed.adjUnitCost;
  var edC=(p.costs||[]).reduce(function(s,c){return s+(c.perEdition&&c.perEdition[ed.id]?c.perEdition[ed.id]:0);},0);
  return ed.ordered>0?edC/ed.ordered:0;
}
function adjTotCost(p){
  return(p.editions||[]).reduce(function(s,ed){return s+edAdjUC(p,ed)*(ed.ordered||0);},0);
}
function effectiveUnitCost(p){var o=totOrd(p);return o>0?adjTotCost(p)/o:0;}
function toggleSimpleUC(){
  S.showSimpleUC=!S.showSimpleUC;
  var btn=document.getElementById('simpleUCBtn');
  if(btn)btn.textContent='å˜ç´”åŸä¾¡ '+(S.showSimpleUC?'è¡¨ç¤º':'éè¡¨ç¤º');
  renderPM();
}
function openAdjUC(pid,eid){
  var p=S.p.find(function(x){return x.id===pid;});if(!p)return;
  var ed=(p.editions||[]).find(function(e){return e.id===eid;});if(!ed)return;
  var edCost=(p.costs||[]).reduce(function(s,c){return s+(c.perEdition&&c.perEdition[ed.id]?c.perEdition[ed.id]:0);},0);
  var simpleUC=ed.ordered>0?(edCost/ed.ordered).toFixed(1):'-';
  var curAdj=ed.adjUnitCost!=null?ed.adjUnitCost:'';
  var html='<div class="mtit">èª¿æ•´åŸä¾¡ã‚’è¨­å®š</div>'
    +'<div style="background:var(--bg3);border-radius:8px;padding:10px 12px;margin-bottom:12px;font-size:12px;">'
    +'<div>ç‰ˆ: <strong>'+ed.label+'</strong> / å°åˆ·: '+ed.ordered+'éƒ¨</div>'
    +'<div style="color:var(--text2);">å˜ç´”åŸä¾¡: <span style="font-family:monospace;">ï¿¥'+simpleUC+'/éƒ¨</span></div>'
    +'<div style="color:var(--text2);">ç·åŸä¾¡: <span style="font-family:monospace;">ï¿¥'+edCost.toLocaleString()+'</span></div>'
    +'</div>'
    +'<div class="fg"><label class="fl">èª¿æ•´åŸä¾¡ (å††/éƒ¨) â€” ç©ºæ¬„ã§å˜ç´”åŸä¾¡ã‚’ä½¿ç”¨</label>'
    +'<input class="fi" id="adjUCInput" type="number" min="0" step="1" placeholder="ä¾‹: 400" value="'+curAdj+'"></div>'
    +'<div class="mact">'
    +'<button class="btn bg" onclick="closeM()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>'
    +'<button class="btn bd bsm" onclick="clearAdjUC(\''+pid+'\',\''+eid+'\')">\u30af\u30ea\u30a2</button>'
    +'<button class="btn bp" onclick="saveAdjUC(\''+pid+'\',\''+eid+'\')">\u8a2d\u5b9a</button>'
    +'</div>';
  openM(html);
}
function saveAdjUC(pid,eid){
  var p=S.p.find(function(x){return x.id===pid;});if(!p)return;
  var ed=(p.editions||[]).find(function(e){return e.id===eid;});if(!ed)return;
  var val=document.getElementById('adjUCInput').value;
  if(val===''||val==null){ed.adjUnitCost=null;}
  else{ed.adjUnitCost=Math.max(0,parseFloat(val)||0);}
  save();closeM();renderPM();showToast('èª¿æ•´åŸä¾¡ã‚’è¨­å®šã—ã¾ã—ãŸ');
}
function clearAdjUC(pid,eid){
  var p=S.p.find(function(x){return x.id===pid;});if(!p)return;
  var ed=(p.editions||[]).find(function(e){return e.id===eid;});if(!ed)return;
  ed.adjUnitCost=null;save();closeM();renderPM();showToast('èª¿æ•´åŸä¾¡ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
}
function togAcc(id){
  if(openAcc.has(id))openAcc.delete(id);else openAcc.add(id);
  var b=document.getElementById(id),a=document.getElementById('aa-'+id);
  if(b)b.classList.toggle('open',openAcc.has(id));
  if(a)a.classList.toggle('open',openAcc.has(id));
}
function restoreAcc(){openAcc.forEach(function(id){var b=document.getElementById(id),a=document.getElementById('aa-'+id);if(b)b.classList.add('open');if(a)a.classList.add('open');});}
function showDD(inputId){
  var el=document.getElementById(inputId);if(!el)return;
  var saved=el.value;el.value='';el.dispatchEvent(new Event('input',{bubbles:true}));el.click();
  setTimeout(function(){if(el.value==='')el.value=saved;},100);
}
function updProdField(pid,field,val){var p=S.p.find(function(x){return x.id===pid;});if(!p)return;if(field==='title'){if(!val.trim())return;p.title=val.trim();}else p[field]=val||'ğŸ“–';save();}
function updProdNum(pid,field,val){var p=S.p.find(function(x){return x.id===pid;});if(!p)return;var n=val===''?0:(parseInt(val)||0);p[field]=Math.max(0,n);save();if(field==='stock')setTimeout(function(){renderPM();},100);}
function updEdLbl(pid,eid,val){var p=S.p.find(function(x){return x.id===pid;});if(!p)return;var e=(p.editions||[]).find(function(e){return e.id===eid;});if(e){e.label=val||e.label;save();}}
function updEd(pid,eid,val){var p=S.p.find(function(x){return x.id===pid;});if(!p)return;var e=(p.editions||[]).find(function(e){return e.id===eid;});if(e){e.ordered=Math.max(0,parseInt(val)||0);save();refreshEdUC(pid);}}
function updCostName(pid,cid,val){var p=S.p.find(function(x){return x.id===pid;});if(!p)return;var c=(p.costs||[]).find(function(c){return c.id===cid;});if(c){c.name=val||c.name;save();}}
function updCostEdAmt(pid,cid,eid,val){
  var p=S.p.find(function(x){return x.id===pid;});if(!p)return;
  var c=(p.costs||[]).find(function(c){return c.id===cid;});if(!c)return;
  if(!c.perEdition)c.perEdition={};
  var n=Math.max(0,parseInt(val)||0);
  c.perEdition[eid]=n;
  c.amount=Object.values(c.perEdition).reduce(function(s,v){return s+(v||0);},0);
  save();refreshEdUC(pid);
}
function refreshEdUC(pid){
  var p=S.p.find(function(x){return x.id===pid;});if(!p)return;
  (p.editions||[]).forEach(function(ed){
    var edCost=(p.costs||[]).reduce(function(s,c){return s+(c.perEdition&&c.perEdition[ed.id]?c.perEdition[ed.id]:0);},0);
    var edUC=ed.ordered>0?edCost/ed.ordered:0;
    var spanUC=document.getElementById('uc-'+pid+'-'+ed.id);
    if(spanUC)spanUC.textContent='å˜ç´”Â¥'+(edUC).toFixed(1)+'/éƒ¨';
    var spanEC=document.getElementById('ec-'+pid+'-'+ed.id);
    if(spanEC)spanEC.textContent='Â¥'+edCost.toLocaleString();
  });
}
function delEdSafe(pid,eid){var p=S.p.find(function(x){return x.id===pid;});if(!p)return;p.editions=(p.editions||[]).filter(function(e){return e.id!==eid;});(p.costs||[]).forEach(function(c){if(c.perEdition)delete c.perEdition[eid];});openAcc.add('acc-ed-'+pid);save();renderPM();}
function delCostSafe(pid,cid){var p=S.p.find(function(x){return x.id===pid;});if(!p)return;p.costs=(p.costs||[]).filter(function(c){return c.id!==cid;});save();renderPM();}
function addEd(pid){
  var p=S.p.find(function(x){return x.id===pid;});if(!p)return;
  if(!p.editions)p.editions=[];
  var n=p.editions.length+1,eid=uid();
  p.editions.push({id:eid,label:'ç¬¬'+n+'ç‰ˆ',ordered:0});
  (p.costs||[]).forEach(function(c){if(!c.perEdition)c.perEdition={};c.perEdition[eid]=0;});
  openAcc.add('acc-ed-'+pid);save();renderPM();
}
function addCostForEd(pid,eid){
  var name=document.getElementById('cn-'+pid+'-'+eid)?document.getElementById('cn-'+pid+'-'+eid).value.trim():'';
  var amount=Math.max(0,parseInt((document.getElementById('ca-'+pid+'-'+eid)||{}).value)||0);
  if(!name){showToast('é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  var p=S.p.find(function(x){return x.id===pid;});if(!p)return;
  if(!p.costs)p.costs=[];
  var cid=uid(),perEdition={};
  (p.editions||[]).forEach(function(e){perEdition[e.id]=0;});
  perEdition[eid]=amount;
  var total=Object.values(perEdition).reduce(function(s,v){return s+(v||0);},0);
  p.costs.push({id:cid,name:name,amount:total,perEdition:perEdition});
  openAcc.add('acc-cost-'+pid+'-'+eid);save();renderPM();
}
function openAddStock(pid){
  var p=S.p.find(function(x){return x.id===pid;});if(!p)return;
  openM('<div class="mtit">ğŸ“¦ åœ¨åº«è¿½åŠ ã€Œ'+p.title+'ã€</div>'
    +'<div style="font-size:13px;color:var(--text2);margin-bottom:11px;">ç¾åœ¨ã®åœ¨åº«: <strong>'+p.stock+'éƒ¨</strong></div>'
    +'<div class="fg"><label class="fl">è¿½åŠ éƒ¨æ•°</label><input class="fi" id="asq" type="number" min="0" placeholder="0"></div>'
    +'<div class="mact"><button class="btn bg" onclick="closeM()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn bp" onclick="doAddStock(\''+pid+'\')">åœ¨åº«ã‚’è¿½åŠ </button></div>');
}
function doAddStock(pid){var q=Math.max(0,parseInt(document.getElementById('asq').value)||0);var p=S.p.find(function(x){return x.id===pid;});if(!p)return;p.stock+=q;save();closeM();renderPM();showToast('åœ¨åº«ã‚’'+q+'éƒ¨è¿½åŠ ã—ã¾ã—ãŸ');}
function openAddProduct(){
  var nextNum=S.p.length>0?Math.max.apply(null,S.p.map(function(x){return x.sortNum||0;}))+1:1;
  openM('<div class="mtit">å•†å“ã‚’è¿½åŠ </div>'
    +'<div style="display:grid;grid-template-columns:60px 1fr;gap:7px;align-items:end;">'
    +'<div class="fg"><label class="fl">No.</label><input class="fi" id="pNum" type="number" min="1" value="'+nextNum+'" style="text-align:center;font-weight:700;"></div>'
    +'<div class="fg"><label class="fl">çµµæ–‡å­—</label><input class="fi" id="pEmo" value="ğŸ“–" style="font-size:20px;width:60px;"></div>'
    +'</div>'
    +'<div class="fg"><label class="fl">ã‚¿ã‚¤ãƒˆãƒ« *</label><input class="fi" id="pTit" placeholder="èªŒåãƒ»ã‚°ãƒƒã‚ºå"></div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;">'
    +'<div class="fg"><label class="fl">ã‚¤ãƒ™ãƒ³ãƒˆä¾¡æ ¼</label><input class="fi" id="pPri" type="number" min="0" placeholder="0"></div>'
    +'<div class="fg"><label class="fl">æ›¸åº—ä¾¡æ ¼</label><input class="fi" id="pSho" type="number" min="0" placeholder="0"></div>'
    +'</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:7px;">'
    +'<div class="fg"><label class="fl">åˆæœŸç™ºè¡Œéƒ¨æ•°(ç¬¬1ç‰ˆ)</label><input class="fi" id="pOrd" type="number" min="0" placeholder="0"></div>'
    +'<div class="fg"><label class="fl">åˆæœŸåœ¨åº«</label><input class="fi" id="pStk" type="number" min="0" placeholder="0"></div>'
    +'</div>'
    +'<div class="mact"><button class="btn bg" onclick="closeM()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn bp" onclick="doAddProd()">è¿½åŠ ã™ã‚‹</button></div>');
}
function doAddProd(){
  var title=document.getElementById('pTit').value.trim();if(!title){showToast('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  var sortNum=parseInt((document.getElementById('pNum')||{}).value)||S.p.length+1;
  var eid=uid();
  S.p.push({id:uid(),title:title,sortNum:sortNum,emoji:document.getElementById('pEmo').value||'ğŸ“–',
    price:Math.max(0,parseInt(document.getElementById('pPri').value)||0),
    shopPrice:Math.max(0,parseInt(document.getElementById('pSho').value)||0),
    stock:Math.max(0,parseInt(document.getElementById('pStk').value)||0),
    coverImg:null,costs:[],editions:[{id:eid,label:'ç¬¬1ç‰ˆ',ordered:Math.max(0,parseInt(document.getElementById('pOrd').value)||0)}]});
  save();closeM();renderPM();showToast('å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}
function delProd(pid){openM('<div class="mtit">å•†å“ã‚’å‰Šé™¤</div><div class="msub">ã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚</div><div class="mact"><button class="btn bg" onclick="closeM()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn bd" onclick="doDel(\''+pid+'\')">å‰Šé™¤ã™ã‚‹</button></div>');}
function doDel(pid){S.p=S.p.filter(function(p){return p.id!==pid;});S.e.forEach(function(e){e.productIds=(e.productIds||[]).filter(function(id){return id!==pid;});});save();closeM();renderPM();showToast('å‰Šé™¤ã—ã¾ã—ãŸ');}
function rmImg(pid){var p=S.p.find(function(x){return x.id===pid;});if(p){p.coverImg=null;save();renderPM();}}

// ================================================================ IMAGE DROP
function openImgDrop(pid){
  imgPid=pid;imgDataUrl=null;
  var p=S.p.find(function(x){return x.id===pid;}),prev=document.getElementById('idPrev'),apb=document.getElementById('idApply');
  if(p&&p.coverImg){prev.src=p.coverImg;prev.classList.add('vis');apb.disabled=false;apb.style.opacity='1';}
  else{prev.src='';prev.classList.remove('vis');apb.disabled=true;apb.style.opacity='.5';}
  document.getElementById('idOver').classList.add('open');
  var zone=document.getElementById('idZone');
  zone.ondragover=function(e){e.preventDefault();zone.classList.add('drag');};
  zone.ondragleave=function(){zone.classList.remove('drag');};
  zone.ondrop=function(e){e.preventDefault();zone.classList.remove('drag');var f=e.dataTransfer.files[0];if(f&&f.type.startsWith('image/'))loadImg(f);};
}
function handleImgFile(ev){var f=ev.target.files[0];if(f)loadImg(f);ev.target.value='';}
function loadImg(file){var r=new FileReader();r.onload=function(e){imgDataUrl=e.target.result;var prev=document.getElementById('idPrev');prev.src=imgDataUrl;prev.classList.add('vis');var apb=document.getElementById('idApply');apb.disabled=false;apb.style.opacity='1';};r.readAsDataURL(file);}
function applyImg(){if(!imgPid||!imgDataUrl)return;var p=S.p.find(function(x){return x.id===imgPid;});if(!p)return;p.coverImg=imgDataUrl;save();closeImgDrop();renderPM();showToast('ç”»åƒã‚’è¨­å®šã—ã¾ã—ãŸ');}
function closeImgDrop(){imgPid=null;imgDataUrl=null;document.getElementById('idOver').classList.remove('open');}

// ================================================================ EVENTS
function renderEV(){
  var el=document.getElementById('evList');
  if(!S.e||!S.e.length){el.innerHTML='<div class="empty"><div class="emico">ğŸ“…</div><div>ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div></div>';return;}
  el.innerHTML=S.e.map(renderEVRow).join('');
}
function renderEVRow(ev){
  var evSales=S.s.filter(function(s){return s.eid===ev.id;});
  var tot=evSales.reduce(function(s,x){return s+x.price*x.qty;},0);
  var expTot=(ev.expenses||[]).reduce(function(s,e){return s+e.amount;},0);
  var checks=S.p.map(function(p){
    var chk=(ev.productIds||[]).includes(p.id);
    return '<div class="epitem '+(chk?'chk':'')+'" onclick="togEvProd(\''+ev.id+'\',\''+p.id+'\')">'
      +'<div class="epbox">'+(chk?'<span style="color:#fff;font-size:13px;">âœ“</span>':'')+'</div>'
      +'<span style="font-size:12px;">'+(p.emoji||'ğŸ“–')+' '+p.title+'</span></div>';
  }).join('');
  var expRows=(ev.expenses||[]).map(function(x){
    return '<div class="erow">'
      +'<div class="ddwrap" style="max-width:140px;">'
      +'<input class="erinp lbl" id="exp-nm-'+ev.id+'-'+x.id+'" list="expp-'+ev.id+'-'+x.id+'" style="width:100%;padding-right:24px;" value="'+x.name.replace(/"/g,'&quot;')+'" onchange="updExpName(\''+ev.id+'\',\''+x.id+'\',this.value)" onclick="event.stopPropagation();this.select()">'
      +'<datalist id="expp-'+ev.id+'-'+x.id+'"><option value="å‚åŠ è²»"><option value="äº¤é€šè²»"><option value="å®¿æ³Šè²»"><option value="å°åˆ·è²»"><option value="å£²å­è²»"></datalist>'
      +'<button class="ddbtn" onclick="event.stopPropagation();showDD(\'exp-nm-'+ev.id+'-'+x.id+'\')" tabindex="-1">â–¼</button>'
      +'</div>'
      +'<input class="erinp amt" type="number" min="0" value="'+x.amount+'" onchange="updExpAmt(\''+ev.id+'\',\''+x.id+'\',this.value)" onclick="event.stopPropagation();this.select()">'
      +'<span style="font-size:11px;color:var(--text3);">å††</span>'
      +(!ev.isLocked?'<button class="erdel" onclick="event.stopPropagation();delExp(\''+ev.id+'\',\''+x.id+'\')">âœ•</button>':'')
      +'</div>';
  }).join('');
  return '<div class="card">'
    +'<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;">'
    +'<div><div style="font-size:15px;font-weight:700;">'+ev.name+'</div>'
    +'<div style="font-size:12px;color:var(--text2);">'+ev.date+'</div>'
    +'<div style="font-size:12px;color:var(--text2);">å£²ä¸Š: <span style="color:var(--green);">Â¥'+tot.toLocaleString()+'</span> / '+evSales.reduce(function(s,x){return s+x.qty;},0)+'éƒ¨</div>'
    +'</div>'
    +'<div class="lbadge '+(ev.isLocked?'lk':'ulk')+'" onclick="togLock(\''+ev.id+'\')">'+(ev.isLocked?'ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­':'ğŸ”“ ç·¨é›†å¯')+'</div>'
    +'</div>'
    +'<div class="acc"><div class="acch" onclick="togAcc(\'acc-evp-'+ev.id+'\')">'
    +'<span class="accl">ğŸ“¦ é ’å¸ƒå•†å“ ('+(ev.productIds||[]).length+'ä»¶)</span>'
    +'<span class="acca '+(openAcc.has('acc-evp-'+ev.id)?'open':'')+'" id="aa-acc-evp-'+ev.id+'">â–¼</span>'
    +'</div><div class="accb '+(openAcc.has('acc-evp-'+ev.id)?'open':'')+'" id="acc-evp-'+ev.id+'">'
    +'<div class="eplist" style="padding-top:6px;">'+(checks||'<div style="font-size:12px;color:var(--text3);">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>')+'</div>'
    +'</div></div>'
    +'<div class="acc"><div class="acch" onclick="togAcc(\'acc-exp-'+ev.id+'\')">'
    +'<span class="accl">ğŸ’´ çµŒè²» (Â¥'+expTot.toLocaleString()+')</span>'
    +'<span class="acca '+(openAcc.has('acc-exp-'+ev.id)?'open':'')+'" id="aa-acc-exp-'+ev.id+'">â–¼</span>'
    +'</div><div class="accb '+(openAcc.has('acc-exp-'+ev.id)?'open':'')+'" id="acc-exp-'+ev.id+'">'
    +(expRows||'<div style="font-size:12px;color:var(--text3);padding:4px 0;">çµŒè²»ãªã—</div>')
    +(!ev.isLocked?'<div style="display:flex;gap:5px;margin-top:8px;align-items:flex-end;">'
      +'<div style="flex:1;"><div style="font-size:10px;color:var(--text3);margin-bottom:3px;">çµŒè²»å</div>'
      +'<div class="ddwrap"><input class="fi" id="en-'+ev.id+'" list="enp-'+ev.id+'" placeholder="å‚åŠ è²»" style="font-size:12px;padding:6px 8px;padding-right:30px;">'
      +'<datalist id="enp-'+ev.id+'"><option value="å‚åŠ è²»"><option value="äº¤é€šè²»"><option value="å®¿æ³Šè²»"><option value="å°åˆ·è²»"><option value="å£²å­è²»"></datalist>'
      +'<button class="ddbtn" onclick="showDD(\'en-'+ev.id+'\')" tabindex="-1">â–¼</button></div></div>'
      +'<div style="width:90px;"><div style="font-size:10px;color:var(--text3);margin-bottom:3px;">é‡‘é¡</div><input class="fi" id="ea-'+ev.id+'" type="number" min="0" placeholder="0" style="font-size:12px;padding:6px 8px;"></div>'
      +'<button class="btn bg bsm" onclick="addExp(\''+ev.id+'\')">è¿½åŠ </button></div>':'')
    +'</div></div>'
    +'<div style="display:flex;gap:5px;margin-top:10px;">'
    +(!ev.isLocked?'<button class="btn bg bsm" onclick="openEditEv(\''+ev.id+'\')">âœï¸ ç·¨é›†</button>':'')
    +'<button class="btn bd bsm" style="margin-left:auto;" onclick="delEv(\''+ev.id+'\')">ğŸ—‘ å‰Šé™¤</button>'
    +'</div></div>';
}
function togEvProd(eid,pid){var ev=S.e.find(function(x){return x.id===eid;});if(!ev)return;if(!ev.productIds)ev.productIds=[];var i=ev.productIds.indexOf(pid);if(i>=0)ev.productIds.splice(i,1);else ev.productIds.push(pid);save();renderEV();}
function updExpName(eid,xid,val){var ev=S.e.find(function(x){return x.id===eid;});if(!ev)return;var x=(ev.expenses||[]).find(function(x){return x.id===xid;});if(x){x.name=val||x.name;save();}}
function updExpAmt(eid,xid,val){var ev=S.e.find(function(x){return x.id===eid;});if(!ev)return;var x=(ev.expenses||[]).find(function(x){return x.id===xid;});if(x){x.amount=Math.max(0,parseInt(val)||0);save();}}
function addExp(eid){var ev=S.e.find(function(x){return x.id===eid;});if(!ev)return;var name=(document.getElementById('en-'+eid)||{}).value;name=name?name.trim():'';var amount=Math.max(0,parseInt((document.getElementById('ea-'+eid)||{}).value)||0);if(!name){showToast('çµŒè²»åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}if(!ev.expenses)ev.expenses=[];ev.expenses.push({id:uid(),name:name,amount:amount});openAcc.add('acc-exp-'+eid);save();renderEV();}
function delExp(eid,xid){var ev=S.e.find(function(x){return x.id===eid;});if(!ev)return;ev.expenses=(ev.expenses||[]).filter(function(x){return x.id!==xid;});save();renderEV();}
function openAddEvent(){
  openM('<div class="mtit">ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ </div>'
    +'<div class="fg"><label class="fl">ã‚¤ãƒ™ãƒ³ãƒˆå</label>'
    +'<div class="ddwrap"><input class="fi" id="evN" list="evp" placeholder="ã‚³ãƒŸãƒ†ã‚£ã‚¢150" style="padding-right:34px;">'
    +'<datalist id="evp"><option value="ã‚³ãƒŸãƒƒã‚¯ãƒãƒ¼ã‚±ãƒƒãƒˆ"><option value="ã‚³ãƒŸãƒ†ã‚£ã‚¢"><option value="æ–‡å­¦ãƒ•ãƒªãƒ"><option value="COMIC1"></datalist>'
    +'<button class="ddbtn" onclick="showDD(\'evN\')" tabindex="-1">â–¼</button></div></div>'
    +'<div class="fg"><label class="fl">é–‹å‚¬æ—¥</label><input class="fi" id="evD" type="date"></div>'
    +'<div class="mact"><button class="btn bg" onclick="closeM()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn bp" onclick="doAddEv()">è¿½åŠ </button></div>');
}
function doAddEv(){var name=(document.getElementById('evN')||{}).value;name=name?name.trim():'';var date=(document.getElementById('evD')||{}).value||'';if(!name||!date){showToast('ã‚¤ãƒ™ãƒ³ãƒˆåã¨æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}S.e.push({id:uid(),name:name,date:date,expenses:[],isLocked:false,productIds:[]});save();closeM();renderEV();showToast('è¿½åŠ ã—ã¾ã—ãŸ');}
function openEditEv(eid){var ev=S.e.find(function(x){return x.id===eid;});if(!ev)return;openM('<div class="mtit">ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç·¨é›†</div><div class="fg"><label class="fl">ã‚¤ãƒ™ãƒ³ãƒˆå</label><input class="fi" id="evEN" value="'+ev.name+'"></div><div class="fg"><label class="fl">é–‹å‚¬æ—¥</label><input class="fi" id="evED" type="date" value="'+ev.date+'"></div><div class="mact"><button class="btn bg" onclick="closeM()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn bp" onclick="doEditEv(\''+eid+'\')">ä¿å­˜</button></div>');}
function doEditEv(eid){var ev=S.e.find(function(x){return x.id===eid;});if(!ev)return;ev.name=document.getElementById('evEN').value.trim();ev.date=document.getElementById('evED').value;save();closeM();renderEV();showToast('æ›´æ–°ã—ã¾ã—ãŸ');}
function togLock(eid){
  var ev=S.e.find(function(x){return x.id===eid;});if(!ev)return;
  if(!ev.isLocked){openM('<div class="mtit">ğŸ”’ ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ­ãƒƒã‚¯</div><div class="msub">ãƒ­ãƒƒã‚¯ã™ã‚‹ã¨å£²ä¸Šè¨˜éŒ²ã®è¿½åŠ ãƒ»å¤‰æ›´ãŒã§ããªããªã‚Šã¾ã™ã€‚</div><div class="mact"><button class="btn bg" onclick="closeM()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn bd" onclick="doLock(\''+eid+'\',true)">ãƒ­ãƒƒã‚¯ã™ã‚‹</button></div>');}
  else{openM('<div class="mtit">ğŸ”“ ãƒ­ãƒƒã‚¯ã‚’è§£é™¤</div><div class="msub">å£²ä¸Šè¨˜éŒ²ã®ç·¨é›†ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚</div><div class="mact"><button class="btn bg" onclick="closeM()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn bs" onclick="doLock(\''+eid+'\',false)">è§£é™¤ã™ã‚‹</button></div>');}
}
function doLock(eid,lk){var ev=S.e.find(function(x){return x.id===eid;});if(ev)ev.isLocked=lk;save();closeM();renderEV();showToast(lk?'ğŸ”’ ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ':'ğŸ”“ è§£é™¤ã—ã¾ã—ãŸ');}
function delEv(eid){openM('<div class="mtit">ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤</div><div class="msub">å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</div><div class="mact"><button class="btn bg" onclick="closeM()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn bd" onclick="doDelEv(\''+eid+'\')">å‰Šé™¤ã™ã‚‹</button></div>');}
function doDelEv(eid){S.e=S.e.filter(function(e){return e.id!==eid;});S.s=S.s.filter(function(s){return s.eid!==eid;});if(S.evId===eid)S.evId=S.e.length?S.e[0].id:null;save();closeM();renderEV();showToast('å‰Šé™¤ã—ã¾ã—ãŸ');}

// ================================================================ ANALYTICS
function setAnMode(m){
  S.anMode=m;
  ['cost','full','sales'].forEach(function(k){
    var btn=document.getElementById('anM_'+k);
    if(btn)btn.classList.toggle('active',k===m);
  });
  renderStats();
}
function renderAN(){
  if(!S.anMode)S.anMode='cost';
  ['cost','full','sales'].forEach(function(k){
    var btn=document.getElementById('anM_'+k);
    if(btn)btn.classList.toggle('active',k===S.anMode);
  });
  if(!S.yAxisSet)S.yAxisSet=new Set(['count']);
  ['count','cumMoney','cumCount','cumTotalMoney'].forEach(function(k){
    var btn=document.getElementById('y'+k.charAt(0).toUpperCase()+k.slice(1));
    if(btn)btn.classList.toggle('active',S.yAxisSet.has(k));
  });
  renderAnEvSel();renderProdCheckboxes();renderStats();renderChart();renderShare();renderHist();
}
function renderAnEvSel(){
  var el=document.getElementById('anEvSel');
  if(!S.anEvId&&S.e.length)S.anEvId=S.e[0].id;
  el.innerHTML=(S.e||[]).map(function(e){return '<div class="echip '+(e.id===S.anEvId?'active':'')+'" onclick="selAnEv(\''+e.id+'\')">'+e.name+'</div>';}).join('');
}
function selAnEv(id){S.anEvId=id;anProdFilter=null;renderAnEvSel();renderProdCheckboxes();renderStats();renderChart();renderShare();renderHist();}
function fSales(){return(S.s||[]).filter(function(s){return s.eid===S.anEvId;});}
function fSalesFiltered(){var all=fSales();if(!anProdFilter)return all;return all.filter(function(s){return anProdFilter.has(s.pid);});}
function renderProdCheckboxes(){
  var el=document.getElementById('prodChecks');
  var sales=fSales();var pids=[...new Set(sales.map(function(s){return s.pid;}))];
  if(!pids.length){el.innerHTML='';return;}
  if(!anProdFilter)anProdFilter=new Set(pids);
  el.innerHTML=pids.map(function(pid,i){
    var p=S.p.find(function(x){return x.id===pid;}),on=anProdFilter.has(pid),col=pCol(i);
    var amt=sales.filter(function(s){return s.pid===pid;}).reduce(function(s,x){return s+x.price*x.qty;},0);
    return '<div class="pchk '+(on?'on':'')+'" onclick="togProdFilter(\''+pid+'\')" style="'+(on?'border-color:'+col+';background:'+col+'22;':'')+'">'
      +'<div class="pchk-dot" style="background:'+col+';'+(on?'':'opacity:.4')+'"></div>'
      +'<span>'+(p?p.emoji||'ğŸ“–':'')+(p?' '+p.title:'ä¸æ˜')+'</span>'
      +'<span style="margin-left:4px;font-family:\'Space Mono\',monospace;font-size:10px;color:'+(on?col:'var(--text3)')+'">Â¥'+amt.toLocaleString()+'</span>'
      +'</div>';
  }).join('');
}
function togProdFilter(pid){if(!anProdFilter)anProdFilter=new Set(fSales().map(function(s){return s.pid;}));if(anProdFilter.has(pid))anProdFilter.delete(pid);else anProdFilter.add(pid);renderProdCheckboxes();renderChart();renderHist();}
function renderStats(){
  var sales=fSales();
  var rev=sales.reduce(function(s,x){return s+x.price*x.qty;},0);
  var qty=sales.reduce(function(s,x){return s+x.qty;},0);
  var cu=0;sales.forEach(function(s){var p=S.p.find(function(x){return x.id===s.pid;});if(p)cu+=effectiveUnitCost(p)*s.qty;});
  var ev=S.e.find(function(e){return e.id===S.anEvId;});
  var exp=(ev&&ev.expenses||[]).reduce(function(s,e){return s+e.amount;},0);
  var mode=S.anMode||'cost';
  var cost=mode==='sales'?0:mode==='full'?cu+exp:cu;
  var profit=rev-cost;
  var modeLabel=mode==='cost'?'åˆ©ç›Š(åŸä¾¡å·®å¼•)':mode==='full'?'åˆ©ç›Š(åŸä¾¡+çµŒè²»)':'å£²ä¸Šã®ã¿';
  var costLabel=mode==='cost'?'åŸä¾¡åˆè¨ˆ':mode==='full'?'åŸä¾¡+çµŒè²»åˆè¨ˆ':'âˆ’';
  var costDisp=mode==='sales'?'âˆ’':'Â¥'+Math.round(cost).toLocaleString();
  document.getElementById('statsGrid').innerHTML=
    '<div class="stc"><div class="slb">ç·å£²ä¸Š</div><div class="sv g">Â¥'+rev.toLocaleString()+'</div></div>'
    +'<div class="stc"><div class="slb">'+modeLabel+'</div><div class="sv '+(profit>=0?'c':'pk')+'">Â¥'+Math.round(profit).toLocaleString()+'</div></div>'
    +'<div class="stc"><div class="slb">ç·é ’å¸ƒæ•°</div><div class="sv y">'+qty+'éƒ¨</div></div>'
    +'<div class="stc"><div class="slb">'+costLabel+'</div><div class="sv">'+costDisp+'</div></div>';
}
function togYA(m){
  if(!S.yAxisSet)S.yAxisSet=new Set(['count']);
  if(S.yAxisSet.has(m))S.yAxisSet.delete(m);else S.yAxisSet.add(m);
  if(S.yAxisSet.size===0)S.yAxisSet.add(m);
  ['count','cumMoney','cumCount','cumTotalMoney'].forEach(function(k){
    var btn=document.getElementById('y'+k.charAt(0).toUpperCase()+k.slice(1));
    if(btn)btn.classList.toggle('active',S.yAxisSet.has(k));
  });
  renderChart();
}
// ç‰ˆã”ã¨ã®éå»å›åæ¸ˆã¿åŸä¾¡ã‚’å·®ã—å¼•ã„ãŸå®ŸåŠ¹åŸä¾¡
function effectiveCostForEvent(pid,currentEventId){
  var p=S.p.find(function(x){return x.id===pid;});
  if(!p)return 0;
  var currentEv=S.e.find(function(e){return e.id===currentEventId;});
  if(!currentEv)return totCost(p);
  var currentDate=currentEv.date;
  var pastEids=S.e.filter(function(e){return e.date<currentDate;}).map(function(e){return e.id;});
  var pastQty=(S.s||[]).filter(function(s){return s.pid===pid&&pastEids.indexOf(s.eid)>=0;}).reduce(function(s,x){return s+x.qty;},0);
  if(pastQty<=0)return adjTotCost(p);
  var remaining=pastQty,effectiveCost=0;
  var eds=p.editions||[];
  for(var j=0;j<eds.length;j++){
    var ed2=eds[j];
    var edC=edAdjUC(p,ed2)*(ed2.ordered||0);
    var edO=ed2.ordered||0;
    if(edO<=0){effectiveCost+=edC;continue;}
    if(remaining>=edO){remaining-=edO;}
    else{effectiveCost+=edC-remaining*edAdjUC(p,ed2);remaining=0;}
  }
  return Math.max(0,Math.round(effectiveCost));
}
function calcAnBreakeven(visPids,anEvId,mode){
  if(mode==='sales')return 0;
  var totalCost=visPids.reduce(function(s,pid){return s+effectiveCostForEvent(pid,anEvId);},0);
  if(mode==='full'){var ev=S.e.find(function(e){return e.id===anEvId;});totalCost+=(ev&&ev.expenses||[]).reduce(function(s,e){return s+e.amount;},0);}
  return Math.round(totalCost);
}
function svgL(x1,y1,x2,y2,stroke,sw,dash){return '<line x1="'+x1+'" y1="'+y1+'" x2="'+x2+'" y2="'+y2+'" stroke="'+stroke+'" stroke-width="'+(sw||1)+'"'+(dash?' stroke-dasharray="'+dash+'"':'')+'/>'}
function svgT(x,y,txt,size,fill,anchor){return '<text x="'+x+'" y="'+y+'" font-size="'+(size||9)+'" fill="'+(fill||'var(--text3)')+'" text-anchor="'+(anchor||'middle')+'">'+txt+'</text>'}
function svgR(x,y,w,h,fill,op,rx){return '<rect x="'+x+'" y="'+y+'" width="'+w+'" height="'+h+'" fill="'+fill+'" opacity="'+(op||1)+'" rx="'+(rx||0)+'"/>'}
function svgC(cx,cy,r,fill){return '<circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="'+fill+'"/>'}
function svgP(d,stroke,sw,dash){return '<path d="'+d+'" fill="none" stroke="'+stroke+'" stroke-width="'+(sw||2)+'" stroke-linejoin="round"'+(dash?' stroke-dasharray="'+dash+'"':'')+'/>';}
function renderChart(){
  var el=document.getElementById('salesCh');if(!el)return;
  if(!S.yAxisSet||S.yAxisSet.size===0)S.yAxisSet=new Set(['count']);
  var allSales=fSales();
  var sh=parseInt((document.getElementById('xS')||{value:10}).value)||10;
  var eh=parseInt((document.getElementById('xE')||{value:16}).value)||16;
  var hrs=[];for(var h=sh;h<=eh;h++)hrs.push(h);
  var allPids=[...new Set(allSales.map(function(s){return s.pid;}))];
  var visPids=allPids.filter(function(pid){return !anProdFilter||anProdFilter.has(pid);});
  if(!visPids.length){el.innerHTML='<div style="font-size:12px;color:var(--text3);padding:18px;text-align:center;">è¡¨ç¤ºã™ã‚‹å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';el.style.height='';renderSoldoutTimeline(hrs,allPids,allSales);return;}

  /* ---- ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ ---- */
  var byPH={};
  visPids.forEach(function(pid){byPH[pid]={};hrs.forEach(function(h){byPH[pid][h]={m:0,c:0};});});
  allSales.filter(function(s){return visPids.includes(s.pid);}).forEach(function(s){
    var hh=new Date(s.ts).getHours();
    if(byPH[s.pid]&&byPH[s.pid][hh]!==undefined){byPH[s.pid][hh].m+=s.price*s.qty;byPH[s.pid][hh].c+=s.qty;}
  });
  var totByH={};hrs.forEach(function(h){totByH[h]={m:0,c:0};});
  visPids.forEach(function(pid){hrs.forEach(function(h){totByH[h].m+=byPH[pid][h].m;totByH[h].c+=byPH[pid][h].c;});});

  var modes=[...S.yAxisSet];
  var hasCount      =modes.indexOf('count')>=0;
  var hasCumMoney   =modes.indexOf('cumMoney')>=0;
  var hasCumCount   =modes.indexOf('cumCount')>=0;
  var hasCumTotalMoney=modes.indexOf('cumTotalMoney')>=0;

  /* ---- å„ãƒ‡ãƒ¼ã‚¿ã®æœ€å¤§å€¤ ---- */
  // æ™‚é–“å¸¯åˆ¥éƒ¨æ•°ã®æœ€å¤§(1æ™‚é–“å†…ã®ç©ã¿ä¸Šã’åˆè¨ˆ)
  var mxC=Math.max.apply(null,hrs.map(function(h){return totByH[h].c;}).concat([1]));
  // å•†å“åˆ¥ç´¯è¨ˆé‡‘é¡ã®æœ€å¤§
  var cumMaxM=0;
  visPids.forEach(function(pid){var r=0;hrs.forEach(function(h){r+=byPH[pid][h].m;});if(r>cumMaxM)cumMaxM=r;});
  // å•†å“åˆ¥ç´¯è¨ˆéƒ¨æ•°ã®æœ€å¤§
  var cumMaxC=0;
  visPids.forEach(function(pid){var r=0;hrs.forEach(function(h){r+=byPH[pid][h].c;});if(r>cumMaxC)cumMaxC=r;});
  // å…¨å•†å“åˆè¨ˆã®ç´¯è¨ˆå£²ä¸Š(= æœ€çµ‚ç´¯è¨ˆå€¤ = ã‚°ãƒ©ãƒ•ãŒåˆ°é”ã™ã‚‹æœ€å¤§å€¤)
  var cumTotalM=hrs.reduce(function(s,h){return s+totByH[h].m;},0);

  /* ---- æç›Šåˆ†å² (ãƒ¢ãƒ¼ãƒ‰ã«é–¢ã‚ã‚‰ãšã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—ã«ä½¿ã†) ---- */
  var beLine=0;
  if(hasCumTotalMoney&&S.anMode!=='sales'){
    beLine=calcAnBreakeven(visPids,S.anEvId,S.anMode);
  }

  /* ---- niceMax: åˆ‡ã‚Šã®è‰¯ã„ä¸Šé™å€¤ ---- */
  function niceMax(val){
    if(val<=0)return 1;
    var mag=Math.pow(10,Math.floor(Math.log10(val)));
    var normalized=val/mag;
    // 1,2,2.5,5,10 ã®ä¸­ã§ ceil
    var steps=[1,2,2.5,5,10];
    for(var si=0;si<steps.length;si++){if(normalized<=steps[si])return steps[si]*mag;}
    return 10*mag;
  }

  /* ---- Yè»¸ã‚¹ã‚±ãƒ¼ãƒ«ç¢ºå®š ---- */
  // å·¦è»¸(é‡‘é¡): hasCumTotalMoneyæ™‚ã¯ç´¯è¨ˆå£²ä¸Šåˆè¨ˆã¨breakevenã®å¤§ãã„æ–¹ã‚’å¿…ãšåã‚ã‚‹
  // å·¦è»¸(é€šå¸¸): è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ãŸæœ€å¤§å€¤
  var leftMoneyMax,leftCountMax;
  if(hasCumTotalMoney){
    // beLine ãŒ cumTotalM ã‚ˆã‚Šå¤§ãã‘ã‚Œã° beLine*1.1 ã¾ã§è»¸ã‚’ä¼¸ã°ã™
    var rawLeftMax=Math.max(cumTotalM,beLine,1);
    // å°‘ã—ä½™ç™½ã‚’æŒãŸã›ã‚‹
    leftMoneyMax=niceMax(rawLeftMax*1.05);
    // å³è»¸: éƒ¨æ•° (count / cumCount ãŒæœ‰åŠ¹æ™‚ã®ã¿)
    leftCountMax=niceMax(Math.max(hasCount?mxC:0,hasCumCount?cumMaxC:0,1));
  } else {
    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: è¡¨ç¤ºã—ã¦ã„ã‚‹ã‚‚ã®ã«å¿œã˜ã¦å·¦è»¸ã‚’æ±ºå®š
    if(hasCount){
      leftCountMax=niceMax(mxC);
    } else if(hasCumCount){
      leftCountMax=niceMax(cumMaxC);
    }
    if(hasCumMoney){
      leftMoneyMax=niceMax(cumMaxM);
    }
  }

  /* ---- SVGæç”»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ---- */
  var LEG_H=visPids.length>0?Math.ceil(visPids.length/3)*14+10:0;
  var LEG_H2=hasCumTotalMoney?18:0;
  // å³è»¸ãŒå¿…è¦ãªã¨ãå³ãƒãƒ¼ã‚¸ãƒ³ã‚’åºƒã’ã‚‹
  var needRightAx=hasCumTotalMoney&&(hasCount||hasCumCount);
  var W=320,H=200,pL=44,pR=needRightAx?W-28:W-10;
  var pT=14,pB=H-20,gW=pR-pL,gH=pB-pT;
  var nH=hrs.length,slotW=nH>1?gW/nH:gW;
  function bx(i){return pL+i*slotW+slotW/2;}
  // Yå¤‰æ›é–¢æ•°(maxã‚’å¤–ã‹ã‚‰å—ã‘å–ã‚‹)
  function gyM(v){return pT+gH-(v/(leftMoneyMax||1))*gH;}  // é‡‘é¡è»¸
  function gyC(v){return pT+gH-(v/(leftCountMax||1))*gH;}  // éƒ¨æ•°è»¸

  var inner='';
  inner+=svgL(pL,pT,pL,pB,'var(--border)',1);
  inner+=svgL(pL,pB,pR,pB,'var(--border)',1);
  inner+=hrs.map(function(h,i){return svgT(bx(i),pB+12,h+'æ™‚',8,'var(--text3)','middle');}).join('');

  /* ---- è»¸ãƒ©ãƒ™ãƒ«æç”» ---- */
  if(hasCumTotalMoney){
    // å·¦è»¸=é‡‘é¡
    [0,.25,.5,.75,1].forEach(function(r){
      var y=pT+gH*(1-r);
      var v=r*leftMoneyMax;
      var lbl=r===0?'0':(v>=10000?Math.round(v/1000)+'k':v.toFixed(0));
      inner+=svgL(pL,y,pR,y,'var(--border)',.4);
      inner+=svgT(pL-4,y+3,lbl,8,'var(--text3)','end');
    });
    // å³è»¸=éƒ¨æ•° (è¡¨ç¤ºã™ã‚‹å ´åˆ)
    if(needRightAx){
      [0,.25,.5,.75,1].forEach(function(r){
        var y=pT+gH*(1-r);
        var v=Math.round(r*leftCountMax);
        inner+=svgT(W-4,y+3,v,7,'var(--cyan)','end');
      });
    }
  } else {
    // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: å·¦è»¸ã¯ä¸»è¦ãªå€¤ã‚¹ã‚±ãƒ¼ãƒ«ã§
    var leftMx=(hasCount||hasCumCount)?leftCountMax:(hasCumMoney?leftMoneyMax:1);
    var leftIsK=!hasCount&&!hasCumCount&&hasCumMoney;
    [0,.25,.5,.75,1].forEach(function(r){
      var y=pT+gH*(1-r);
      var v=r*leftMx;
      var lbl=r===0?'0':(leftIsK?(v>=10000?Math.round(v/1000)+'k':v.toFixed(0)):Math.round(v).toString());
      inner+=svgL(pL,y,pR,y,'var(--border)',.4);
      inner+=svgT(pL-4,y+3,lbl,8,'var(--text3)','end');
    });
    // hasCumMoney ã‹ã¤ count/cumCount ã‚‚è¡¨ç¤ºä¸­ãªã‚‰å³è»¸ã«é‡‘é¡ã‚¹ã‚±ãƒ¼ãƒ«
    if(hasCumMoney&&(hasCount||hasCumCount)){
      [0,.25,.5,.75,1].forEach(function(r){
        var y=pT+gH*(1-r);
        var v=r*leftMoneyMax;
        inner+=svgT(pR+4,y+3,r===0?'0':(v>=10000?Math.round(v/1000)+'k':Math.round(v).toString()),7,'var(--text2)','start');
      });
    }
  }

  /* ---- ã‚°ãƒ©ãƒ•æœ¬ä½“ ---- */

  // æ£’ã‚°ãƒ©ãƒ• (æ™‚é–“å¸¯åˆ¥éƒ¨æ•°) â†’ éƒ¨æ•°è»¸
  if(hasCount){
    hrs.forEach(function(h,hi){
      var stackY=pB;
      visPids.forEach(function(pid){
        var v=byPH[pid][h].c;if(!v)return;
        var bh=(v/leftCountMax)*gH,col=pCol(allPids.indexOf(pid)),bw=slotW*0.65;
        inner+=svgR(bx(hi)-bw/2,stackY-bh,bw,bh,col,.75,1);
        if(bh>9)inner+=svgT(bx(hi),stackY-bh/2,v,7,'#fff','middle');
        stackY-=bh;
      });
    });
  }

  // ç´¯è¨ˆéƒ¨æ•° â†’ éƒ¨æ•°è»¸
  if(hasCumCount){
    visPids.forEach(function(pid){
      var col=pCol(allPids.indexOf(pid)),run=0;
      var d=hrs.map(function(h,i){run+=byPH[pid][h].c;return(i===0?'M':'L')+bx(i)+','+gyC(run);}).join(' ');
      inner+=svgP(d,col,hasCount?1.5:2);
      run=0;hrs.forEach(function(h,i){run+=byPH[pid][h].c;inner+=svgC(bx(i),gyC(run),2.5,col);});
    });
  }

  // ç´¯è¨ˆé‡‘é¡(å•†å“åˆ¥ç ´ç·š) â†’ é‡‘é¡è»¸
  if(hasCumMoney){
    visPids.forEach(function(pid){
      var col=pCol(allPids.indexOf(pid)),run=0;
      var useM=hasCumTotalMoney?gyM:((hasCount||hasCumCount)?function(v){return pT+gH-(v/(leftMoneyMax||1))*gH;}:gyM);
      var d=hrs.map(function(h,i){run+=byPH[pid][h].m;return(i===0?'M':'L')+bx(i)+','+useM(run);}).join(' ');
      inner+=svgP(d,col,2,'6,2');
      run=0;hrs.forEach(function(h,i){run+=byPH[pid][h].m;inner+=svgC(bx(i),useM(run),3,col);});
    });
  }

  // ç´¯è¨ˆå£²ä¸Šåˆè¨ˆ (ç™½å®Ÿç·š) â†’ é‡‘é¡è»¸
  if(hasCumTotalMoney){
    var runT=0;
    var dT=hrs.map(function(h,i){runT+=totByH[h].m;return(i===0?'M':'L')+bx(i)+','+gyM(runT);}).join(' ');
    inner+=svgP(dT,'#ffffff',2.5);
    runT=0;
    hrs.forEach(function(h,i){
      runT+=totByH[h].m;
      inner+=svgC(bx(i),gyM(runT),3.5,'#ffffff');
      if(runT>0){
        var v=runT;
        var lbl=v>=10000?Math.round(v/1000)+'k':v.toFixed(0);
        inner+=svgT(bx(i),gyM(runT)-7,lbl,8,'#ffffff','middle');
      }
    });

    // æç›Šåˆ†å²æ°´å¹³ç·š â†’ é‡‘é¡è»¸
    if(beLine>0){
      var beY=gyM(beLine);
      inner+=svgL(pL,beY,pR,beY,'var(--yellow)',1.5,'4,3');
      var beK=beLine>=10000?Math.round(beLine/1000)+'k':beLine.toLocaleString();
      inner+=svgT(pR-2,beY-3,'Â¥'+beK,8,'var(--yellow)','end');
      inner+=svgT(pL+2,beY-3,'æç›Šåˆ†å²',8,'var(--yellow)','start');
    }
  }

  /* ---- å‡¡ä¾‹ ---- */
  var legSvg='',cols=3,legRowH=13,legX=pL,legY=H+6;
  visPids.forEach(function(pid,li){
    var col=pCol(allPids.indexOf(pid));
    var p=S.p.find(function(x){return x.id===pid;});
    var lbl=p?(p.emoji||'')+(p.title||'?').substr(0,5):'?';
    var row=Math.floor(li/cols),col2=li%cols;
    var lx=legX+col2*(gW/cols),ly=legY+row*legRowH;
    legSvg+=svgR(lx,ly+1,8,8,col,1,2)+svgT(lx+10,ly+8,lbl,9,col,'start');
  });
  if(hasCumTotalMoney){
    var extraY=legY+Math.ceil(visPids.length/cols)*legRowH+2;
    legSvg+='<rect x="'+legX+'" y="'+(extraY+2)+'" width="16" height="3" fill="#ffffff" rx="1"/>';
    legSvg+=svgT(legX+20,extraY+8,'ç´¯è¨ˆå£²ä¸Šåˆè¨ˆ',9,'#ffffff','start');
    if(beLine>0){
      var beLbl=S.anMode==='full'?'æç›Šåˆ†å²(åŸä¾¡+çµŒè²»)':'æç›Šåˆ†å²(åŸä¾¡ã®ã¿)';
      legSvg+='<line x1="'+(legX+100)+'" y1="'+(extraY+4)+'" x2="'+(legX+116)+'" y2="'+(extraY+4)+'" stroke="var(--yellow)" stroke-width="1.5" stroke-dasharray="4,2"/>';
      legSvg+=svgT(legX+120,extraY+8,beLbl,9,'var(--yellow)','start');
    }
  }

  var totalH=H+LEG_H+LEG_H2+4;
  el.style.height=totalH+'px';
  el.innerHTML='<svg viewBox="0 0 '+W+' '+totalH+'" style="width:100%;height:100%;">'+inner+legSvg+'</svg>';
  renderSoldoutTimeline(hrs,allPids,allSales);
}
function renderSoldoutTimeline(hrs,allPids,allSales){
  var el=document.getElementById('soldoutTimeline');if(!el)return;
  var items=[];
  allPids.forEach(function(pid,i){
    if(anProdFilter&&!anProdFilter.has(pid))return;
    var p=S.p.find(function(x){return x.id===pid;});if(!p)return;
    var evSold=allSales.filter(function(s){return s.pid===pid;}).reduce(function(s,x){return s+x.qty;},0);
    var initStock=p.stock+evSold;if(initStock<=0)return;
    var cum=0,soldoutH=null,soldoutMin=null;
    var evts=allSales.filter(function(s){return s.pid===pid;}).sort(function(a,b){return new Date(a.ts)-new Date(b.ts);});
    for(var j=0;j<evts.length;j++){cum+=evts[j].qty;if(cum>=initStock&&soldoutH===null){var d=new Date(evts[j].ts);soldoutH=d.getHours();soldoutMin=d.getMinutes();break;}}
    if(soldoutH!==null){var col=pCol(i),mm=String(soldoutMin).padStart(2,'0');items.push('<div style="display:flex;align-items:center;gap:8px;padding:5px 0;border-bottom:1px solid var(--border);"><div style="width:8px;height:8px;border-radius:50%;background:'+col+';flex-shrink:0;"></div><span style="font-size:12px;flex:1;">'+(p.emoji||'ğŸ“–')+' '+p.title+'</span><span style="font-size:11px;color:var(--red);font-weight:700;">ğŸ '+soldoutH+':'+mm+' å®Œå£²</span></div>');}
  });
  el.innerHTML=items.length?'<div style="background:rgba(248,113,113,.07);border:1px solid rgba(248,113,113,.25);border-radius:6px;padding:8px 10px;"><div style="font-size:11px;font-weight:700;color:var(--red);margin-bottom:4px;">ğŸ å®Œå£²ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</div>'+items.join('')+'</div>':'';
}
function renderShare(){
  var el=document.getElementById('shareCh'),sales=fSales();
  if(!sales.length){el.innerHTML='<div class="empty" style="padding:18px;">ãƒ‡ãƒ¼ã‚¿ãªã—</div>';return;}
  var byP={};sales.forEach(function(s){byP[s.pid]=(byP[s.pid]||0)+s.price*s.qty;});
  var tot=Object.values(byP).reduce(function(s,v){return s+v;},0);
  var pids=Object.keys(byP);var bars='',leg='';
  pids.forEach(function(pid,i){var amt=byP[pid],pct=Math.round(amt/tot*100),col=pCol(i),p=S.p.find(function(x){return x.id===pid;});bars+='<div style="height:100%;flex:'+pct+';background:'+col+';min-width:'+(pct?'2px':'0')+'"></div>';leg+='<div style="display:flex;align-items:center;gap:4px;font-size:11px;"><div style="width:8px;height:8px;border-radius:50%;background:'+col+';flex-shrink:0;"></div><span style="max-width:85px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">'+(p?p.title:'ä¸æ˜')+'</span><span style="color:var(--text2);">'+pct+'%</span></div>';});
  el.innerHTML='<div style="height:28px;display:flex;border-radius:4px;overflow:hidden;margin-bottom:9px;">'+bars+'</div><div style="display:flex;flex-wrap:wrap;gap:7px;">'+leg+'</div>';
}
function renderHist(){
  var el=document.getElementById('salesHist'),sales=fSalesFiltered().slice().reverse();
  if(!sales.length){el.innerHTML='<div style="font-size:12px;color:var(--text3);padding:7px;">å£²ä¸Šè¨˜éŒ²ãªã—</div>';return;}
  el.innerHTML=sales.slice(0,20).map(function(s){var p=S.p.find(function(x){return x.id===s.pid;}),d=new Date(s.ts);var tm=String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0');return '<div class="hitem"><div class="htm">'+tm+'</div><div class="hinf"><div class="htitle2">'+(p?p.title:'ä¸æ˜')+'</div><div class="hqty">Ã— '+s.qty+'éƒ¨</div></div><div class="hamt">Â¥'+(s.price*s.qty).toLocaleString()+'</div></div>';}).join('')+(sales.length>20?'<div style="text-align:center;color:var(--text3);font-size:11px;padding:7px;">â€¦ä»–'+(sales.length-20)+'ä»¶</div>':'');
}
function confirmResetSales(){
  var lockedEvs=(S.e||[]).filter(function(e){return e.isLocked;});
  var unlockedSales=S.s.filter(function(s){var ev=S.e.find(function(e){return e.id===s.eid;});return ev&&!ev.isLocked;});
  if(!unlockedSales.length){showToast('ãƒªã‚»ãƒƒãƒˆã§ãã‚‹å£²ä¸Šè¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  var note=lockedEvs.length>0?'<div style="font-size:11px;color:var(--yellow);margin-top:6px;">âš ï¸ ãƒ­ãƒƒã‚¯ä¸­ã®ã‚¤ãƒ™ãƒ³ãƒˆ('+lockedEvs.map(function(e){return e.name;}).join('ã€')+')ã®å£²ä¸Šã¯ä¿æŒã•ã‚Œã¾ã™</div>':'';
  openM('<div class="mtit">å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ</div><div class="msub">ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„ã‚¤ãƒ™ãƒ³ãƒˆã®å£²ä¸Šè¨˜éŒ²ãŒã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚</div>'+note+'<div class="mact"><button class="btn bg" onclick="closeM()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn bd" onclick="execResetSales()">ãƒªã‚»ãƒƒãƒˆã™ã‚‹</button></div>');
}
function execResetSales(){
  S.s=S.s.filter(function(s){var ev=S.e.find(function(e){return e.id===s.eid;});return ev&&ev.isLocked;});
  S.p.forEach(function(p){var sold=S.s.filter(function(s){return s.pid===p.id;}).reduce(function(a,x){return a+x.qty;},0);p.stock=(p.editions||[]).reduce(function(s,e){return s+(e.ordered||0);},0)-sold;if(p.stock<0)p.stock=0;});
  save();closeM();renderAN();showToast('âœ… å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
}

// ================================================================ SIM
function setSimMode(m){
  S.simMode=m;
  ['cost','full','sales'].forEach(function(k){
    var btn=document.getElementById('smM_'+k);
    if(btn)btn.classList.toggle('active',k===m);
  });
  renderSimChart();renderSimTable();renderSimDet();
}
function renderSIM(){
  renderSimEvSel();
  if(!S.p||!S.p.length){document.getElementById('simTabs').innerHTML='';document.getElementById('simDet').innerHTML='<div class="empty"><div class="emico">ğŸ“¦</div><div>å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div></div>';document.getElementById('simCh').innerHTML='';document.getElementById('simRes').innerHTML='';document.getElementById('simTable').innerHTML='';return;}
  document.getElementById('simTabs').innerHTML=S.p.map(function(p,i){return '<button class="tab '+(i===S.simIdx?'active':'')+'" onclick="setSimIdx('+i+')">'+(p.emoji||'ğŸ“–')+' '+(p.title.length>8?p.title.substr(0,8)+'â€¦':p.title)+'</button>';}).join('');
  // ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³åˆæœŸåŒ–
  if(!S.simMode)S.simMode='cost';
  ['cost','full','sales'].forEach(function(k){var btn=document.getElementById('smM_'+k);if(btn)btn.classList.toggle('active',k===S.simMode);});
  renderSimDet();renderSimChart();renderSimTable();
}
function renderSimEvSel(){
  var el=document.getElementById('simEvSel');
  if(!S.simEvId&&S.e.length)S.simEvId=S.e[0].id;
  el.innerHTML=(S.e||[]).map(function(e){return '<div class="echip '+(e.id===S.simEvId?'active':'')+'" onclick="selSimEv(\''+e.id+'\')">'+e.name+'</div>';}).join('');
  var ev=S.e.find(function(e){return e.id===S.simEvId;});
  var et=ev?(ev.expenses||[]).reduce(function(s,e){return s+e.amount;},0):0;
  document.getElementById('simExpInfo').textContent=ev?(ev.name+': '+(ev.expenses||[]).map(function(e){return e.name+' Â¥'+e.amount.toLocaleString();}).join(' / ')+' (åˆè¨ˆ: Â¥'+et.toLocaleString()+')'):('ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
}
function selSimEv(id){S.simEvId=id;renderSimEvSel();renderSimChart();renderSimTable();}
function setSimIdx(i){S.simIdx=i;renderSIM();}
function gSV(pid,f,def){return simOvr[pid]&&simOvr[pid][f]!==undefined?simOvr[pid][f]:def;}
function getSimCost(p){
  var ev=S.e.find(function(e){return e.id===S.simEvId;});
  var expAmt=(ev&&ev.expenses||[]).reduce(function(s,e){return s+e.amount;},0);
  var base=adjTotCost(p);
  return S.simMode==='sales'?0:S.simMode==='full'?base+expAmt:base;
}
function renderSimDet(){
  var p=S.p[S.simIdx];if(!p)return;
  var sp=gSV(p.id,'price',p.price),so=totOrd(p);
  var fc=getSimCost(p);
  var be=sp>0&&fc>0?Math.ceil(fc/sp):'-',bep=so>0&&sp>0&&fc>0?Math.round(Math.ceil(fc/sp)/so*100):'-';
  var modeLabel=S.simMode==='cost'?'æç›Šåˆ†å²(åŸä¾¡ã®ã¿)':S.simMode==='full'?'æç›Šåˆ†å²(åŸä¾¡+çµŒè²»)':'å£²ä¸Šã®ã¿è¡¨ç¤º';
  document.getElementById('simDet').innerHTML='<div class="card">'
    +'<div style="font-size:15px;font-weight:700;margin-bottom:11px;">'+(p.emoji||'ğŸ“–')+' '+p.title+'</div>'
    +'<div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:11px;">'
    +'<div><div class="fl">è²©å£²ä¾¡æ ¼ (ã‚·ãƒŸãƒ¥)</div>'
    +'<div style="display:flex;align-items:center;gap:6px;">'
    +'<div style="font-family:\'Space Mono\';font-size:17px;color:var(--accent);">Â¥'+sp.toLocaleString()+'</div>'
    +'<button class="btn bg bsm" onclick="openSimNP(\''+p.id+'\',\'price\','+sp+')">å¤‰æ›´</button></div>'
    +(sp!==p.price?'<div class="dold">å…ƒå€¤: Â¥'+p.price.toLocaleString()+'</div>':'')+'</div>'
    +'<div><div class="fl">å°åˆ·éƒ¨æ•°</div><div style="font-family:\'Space Mono\';font-size:17px;color:var(--cyan);">'+totOrd(p)+'éƒ¨</div></div>'
    +'</div>'
    +'<div style="background:var(--bg3);border-radius:8px;padding:11px;">'
    +'<div style="display:flex;justify-content:space-between;margin-bottom:5px;">'
    +'<span style="font-size:12px;color:var(--text2);">'+modeLabel+'</span>'
    +'<span style="font-family:\'Space Mono\';font-size:13px;color:var(--yellow);">'+(S.simMode==='sales'?'âˆ’':be+'éƒ¨ / '+bep+'%')+'</span></div>'
    +(S.simMode!=='sales'?'<div class="bebar"><div class="befill" style="width:'+(typeof bep==='number'?Math.min(bep,100):0)+'%"></div></div>':'')
    +'<div style="font-size:11px;color:var(--text2);">åˆ¶ä½œè²»: <span style="font-family:\'Space Mono\';">Â¥'+totCost(p).toLocaleString()+'</span> / åŸä¾¡/éƒ¨: <span style="color:var(--yellow);font-family:\'Space Mono\';">Â¥'+Math.round(unitCost(p)).toLocaleString()+'</span></div>'
    +'</div>'
    +(simOvr[p.id]?'<button class="btn bp bfull" style="margin-top:11px;" onclick="applySimMaster(\''+p.id+'\')">â˜… ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã«åæ˜ </button>':'')
    +'</div>';
}
function openSimNP(pid,field,cur){
  S.npTarget={pid:pid,field:field};npVal=String(cur);
  document.getElementById('npTit').textContent='è²©å£²ä¾¡æ ¼ã‚’å¤‰æ›´';
  document.getElementById('npDsp').textContent=cur;
  document.getElementById('npQ').innerHTML=['+100','+500','-100','-500'].map(function(v){return '<button class="npqb" onclick="npQAdj('+parseInt(v)+')">'+v+'</button>';}).join('');
  S.npCb=function(val){if(!simOvr[pid])simOvr[pid]={};simOvr[pid][field]=val;renderSimDet();renderSimChart();renderSimTable();};
  document.getElementById('npo').classList.add('open');
}
function npQAdj(d){var c=parseInt(document.getElementById('npDsp').textContent)||0;var n=Math.max(0,c+d);document.getElementById('npDsp').textContent=n;npVal=String(n);}
function applySimMaster(pid){
  var p=S.p.find(function(x){return x.id===pid;}),ov=simOvr[pid];if(!p||!ov)return;
  var changes=[];if(ov.price!==undefined&&ov.price!==p.price)changes.push('ä¾¡æ ¼: <span class="dold">Â¥'+p.price.toLocaleString()+'</span> â†’ <span class="dnew">Â¥'+ov.price.toLocaleString()+'</span>');
  if(!changes.length){showToast('å¤‰æ›´ãªã—');return;}
  openM('<div class="mtit">âš ï¸ ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</div><div class="msub">ä»¥ä¸‹ã®å¤‰æ›´ã‚’å•†å“ãƒ‡ãƒ¼ã‚¿ã«åæ˜ ã—ã¾ã™ï¼š</div><div style="background:var(--bg3);border-radius:8px;padding:11px;margin-bottom:11px;">'+changes.map(function(c){return '<div style="padding:3px 0;">'+c+'</div>';}).join('')+'</div><div style="font-size:11px;color:var(--text2);margin-bottom:11px;">éå»ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã€‚</div><div class="mact"><button class="btn bg" onclick="closeM()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class="btn bp" onclick="doApplySim(\''+pid+'\')">åæ˜ ã™ã‚‹</button></div>');
}
function doApplySim(pid){var p=S.p.find(function(x){return x.id===pid;}),ov=simOvr[pid];if(!p||!ov)return;if(ov.price!==undefined)p.price=ov.price;delete simOvr[pid];save();closeM();renderSIM();showToast('ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸ');}
function renderSimChart(){
  var el=document.getElementById('simCh'),re=document.getElementById('simRes');
  var p=S.p[S.simIdx];if(!p){el.innerHTML='';re.innerHTML='';return;}
  var sp=gSV(p.id,'price',p.price),so=totOrd(p),fc=getSimCost(p);
  var be=sp>0&&fc>0?Math.ceil(fc/sp):0;
  var W=300,H=175,pL=44,pR=10,pT=10,pB=28,gW=W-pL-pR,gH=H-pT-pB;
  var mxQ=Math.max(so,be+10,10),mxA=Math.max(sp*so,fc+1000,1);
  function tx(q){return pL+(q/mxQ)*gW;}function ty(a){return pT+gH-(a/mxA)*gH;}
  var bx=tx(be),by=ty(sp*be);
  var grids=[0,.25,.5,.75,1].map(function(r){var y=pT+gH*(1-r);return '<line x1="'+pL+'" y1="'+y+'" x2="'+(W-pR)+'" y2="'+y+'" stroke="var(--border)" stroke-width=".5"/><text x="'+(pL-4)+'" y="'+(y+3)+'" font-size="9" fill="var(--text3)" text-anchor="end">'+Math.round(r*mxA/1000)+'k</text>';}).join('');
  var xlbs=[0,.25,.5,.75,1].map(function(r){var q=Math.round(r*so),x=tx(q);return '<text x="'+x+'" y="'+(H-7)+'" font-size="9" fill="var(--text3)" text-anchor="middle">'+q+'</text>';}).join('');
  var svgContent=grids+xlbs
    +'<path d="M'+tx(0)+','+ty(0)+' L'+tx(so)+','+ty(sp*so)+'" stroke="var(--green)" stroke-width="2" fill="none"/>'
    +(fc>0?'<path d="M'+tx(0)+','+ty(fc)+' L'+tx(so)+','+ty(fc)+'" stroke="var(--red)" stroke-width="2" fill="none" stroke-dasharray="4,2"/>':'')
    +(be>0&&be<=so?'<polygon points="'+bx+','+by+' '+tx(so)+','+ty(sp*so)+' '+tx(so)+','+ty(fc)+' '+bx+','+by+'" fill="rgba(74,222,128,.1)"/>'
      +'<line x1="'+bx+'" y1="'+pT+'" x2="'+bx+'" y2="'+(pT+gH)+'" stroke="var(--yellow)" stroke-width="1" stroke-dasharray="3,2"/>'
      +'<text x="'+bx+'" y="'+(pT+10)+'" font-size="9" text-anchor="middle" fill="var(--yellow)">'+be+'éƒ¨</text>'
      +'<circle cx="'+bx+'" cy="'+by+'" r="4" fill="var(--yellow)"/>':'')
    +'<line x1="'+pL+'" y1="'+pT+'" x2="'+pL+'" y2="'+(pT+gH)+'" stroke="var(--border)" stroke-width="1"/>'
    +'<line x1="'+pL+'" y1="'+(pT+gH)+'" x2="'+(W-pR)+'" y2="'+(pT+gH)+'" stroke="var(--border)" stroke-width="1"/>'
    +'<text x="'+(W-pR)+'" y="18" font-size="9" text-anchor="end" fill="var(--green)">â€” å£²ä¸Š</text>'
    +(fc>0?'<text x="'+(W-pR)+'" y="29" font-size="9" text-anchor="end" fill="var(--red)">-- ã‚³ã‚¹ãƒˆ</text>':'');
  el.innerHTML='<svg viewBox="0 0 '+W+' '+H+'" style="width:100%;height:100%;">'+svgContent+'</svg>';
  var modeLabel=S.simMode==='cost'?'å˜ç´”æç›Š':S.simMode==='full'?'å®Ÿè³ªåæ”¯':'å£²ä¸Šã®ã¿';
  if(S.simMode==='sales'){re.innerHTML='<span style="color:var(--cyan);">ğŸ’° å£²ä¸Šã®ã¿è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</span> å®Œå£²æ™‚å£²ä¸Š: <span style="color:var(--green);font-weight:700;">Â¥'+(sp*so).toLocaleString()+'</span>';}
  else if(be>0&&be<=so){var bep=so>0?Math.round(be/so*100):0;re.innerHTML='<span style="color:var(--yellow);">ğŸ“Š '+modeLabel+': </span>ã‚ã¨<span style="color:var(--green);font-weight:700;"> '+be+'éƒ¨ï¼ˆ'+bep+'%ï¼‰</span>ã§é»’å­—è»¢æ›';}
  else if(fc>0){re.innerHTML='<span style="color:var(--red);">âš ï¸ å…¨éƒ¨é ’å¸ƒã—ã¦ã‚‚èµ¤å­—ã§ã™</span>ï¼ˆã‚³ã‚¹ãƒˆ: Â¥'+fc.toLocaleString()+'ï¼‰';}
  else{re.innerHTML='<span style="color:var(--green);">âœ… ã‚³ã‚¹ãƒˆãªã—</span>';}
}
function renderSimTable(){
  var el=document.getElementById('simTable');
  var p=S.p[S.simIdx];if(!p){el.innerHTML='';return;}
  var sp=gSV(p.id,'price',p.price),so=totOrd(p),fc=getSimCost(p);
  var be=sp>0&&fc>0?Math.ceil(fc/sp):Infinity;
  if(so<=0){el.innerHTML='<div style="font-size:11px;color:var(--text3);padding:7px;">ç™ºè¡Œéƒ¨æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„</div>';return;}
  var rows=[];for(var pct=10;pct<=100;pct+=10){var qty=Math.round(so*pct/100),rev=sp*qty,profit=rev-fc,isProfit=profit>=0,isBe=qty>=be&&Math.round(so*(pct-10)/100)<be;rows.push({pct:pct,qty:qty,rev:rev,profit:profit,isProfit:isProfit,isBe:isBe});}
  var header=S.simMode==='sales'?'å£²ä¸Š':'åˆ©ç›Š';
  var html='<table class="betable"><thead><tr><th style="text-align:left;">é ’å¸ƒç‡</th><th>éƒ¨æ•°</th><th>å£²ä¸Š</th>'+(S.simMode!=='sales'?'<th>ã‚³ã‚¹ãƒˆ</th>':'')+'<th>'+header+'</th></tr></thead><tbody>';
  rows.forEach(function(r){html+='<tr class="'+(r.isBe?'be-row ':'')+' '+(r.isProfit?'profit':'loss')+'"><td>'+r.pct+'%'+(r.isBe?' ğŸ”¶':'')+'</td><td>'+r.qty+'éƒ¨</td><td>Â¥'+r.rev.toLocaleString()+'</td>'+(S.simMode!=='sales'?'<td>Â¥'+fc.toLocaleString()+'</td>':'')+'<td>'+(r.isProfit&&S.simMode!=='sales'?'+':'')+'Â¥'+r.profit.toLocaleString()+'</td></tr>';});
  html+='</tbody></table><div style="font-size:10px;color:var(--text3);padding:5px 0;">ğŸ”¶ æç›Šåˆ†å²ç‚¹ã‚’è¶…ãˆãŸæœ€åˆã®è¡Œ</div>';
  el.innerHTML=html;
}

// ================================================================ NUMPAD
function openNP(target,cb){S.npTarget=target;S.npCb=cb||null;npVal='0';document.getElementById('npDsp').textContent='0';document.getElementById('npTit').textContent=target==='prepay'?'ãŠé ã‹ã‚Šé‡‘é¡':'é‡‘é¡ã‚’å…¥åŠ›';document.getElementById('npQ').innerHTML=target==='prepay'?['1,000','5,000','10,000','50,000'].map(function(v,i){return '<button class="npqb" onclick="npSet('+[1000,5000,10000,50000][i]+')">'+v+'</button>';}).join(''):'';document.getElementById('npo').classList.add('open');}
function npSet(v){npVal=String(v);document.getElementById('npDsp').textContent=v;}
function npi(d){var c=document.getElementById('npDsp').textContent.replace(/,/g,'');c=c==='0'?(d==='00'?'0':d):c+d;if(c.length>8)c=c.slice(-8);document.getElementById('npDsp').textContent=parseInt(c)||0;npVal=c;}
function npc(){npVal='0';document.getElementById('npDsp').textContent='0';}
function npDone(){var v=parseInt(npVal)||0;if(S.npTarget==='prepay')setPP(v);else if(S.npCb)S.npCb(v);closeNP();}
function closeNP(){document.getElementById('npo').classList.remove('open');S.npCb=null;S.npTarget=null;}

// ================================================================ MODAL
function openM(html){document.getElementById('mcont').innerHTML=html;document.getElementById('mover').classList.add('open');}
function closeM(){document.getElementById('mover').classList.remove('open');}

// ================================================================ TOAST
function showToast(m){var el=document.getElementById('toast');el.textContent=m;el.classList.add('show');setTimeout(function(){el.classList.remove('show');},2200);}

// ================================================================ CSV
function csvR(arr){return arr.map(function(v){return '"'+String(v==null?'':v).replace(/"/g,'""')+'"';}).join(',')+'\n';}
function dlCSV(fn,content){var blob=new Blob(['\uFEFF'+content],{type:'text/csv;charset=utf-8;'});var u=URL.createObjectURL(blob);var a=document.createElement('a');a.href=u;a.download=fn;a.click();URL.revokeObjectURL(u);}
function dlTpl(page){
  var fn='',c='';
  if(page==='products'){fn='å•†å“ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.csv';c='â–  å•†å“ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ\nâ€»ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’æ®‹ã—ãŸã¾ã¾2è¡Œç›®ä»¥é™ã«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›\n\n'+csvR(['No','ã‚¿ã‚¤ãƒˆãƒ«','çµµæ–‡å­—','ã‚¤ãƒ™ãƒ³ãƒˆä¾¡æ ¼','æ›¸åº—ä¾¡æ ¼','ç™ºè¡Œéƒ¨æ•°(ç¬¬1ç‰ˆ)','åœ¨åº«'])+csvR(['1','æ–°åˆŠA','ğŸ“•','1000','800','100','100'])+csvR(['2','æ—¢åˆŠB','ğŸ“˜','700','600','50','50'])+csvR(['3','ã‚°ãƒƒã‚º','ğŸ','500','0','200','200']);}
  else if(page==='events'){fn='ã‚¤ãƒ™ãƒ³ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ.csv';c='â–  ã‚¤ãƒ™ãƒ³ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ\nâ€»æ—¥ä»˜ã¯YYYY-MM-DDå½¢å¼\n\n'+csvR(['ã‚¤ãƒ™ãƒ³ãƒˆå','é–‹å‚¬æ—¥'])+csvR(['ã‚³ãƒŸãƒ†ã‚£ã‚¢150','2026-05-05'])+csvR(['ã‚³ãƒŸã‚±110','2026-12-28']);}
  else if(page==='analytics'){fn='åˆ†æãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆèª¬æ˜.csv';c='â–  åˆ†æCSVã«å«ã¾ã‚Œã‚‹ã‚·ãƒ¼ãƒˆ\n\n'+csvR(['ã‚·ãƒ¼ãƒˆ','å†…å®¹'])+csvR(['ã‚¤ãƒ™ãƒ³ãƒˆã‚µãƒãƒªãƒ¼','ç·å£²ä¸Šãƒ»åˆ©ç›Šãƒ»çµŒè²»'])+csvR(['å•†å“åˆ¥å£²ä¸Š','é ’å¸ƒæ•°ãƒ»ç²—åˆ©ãªã©'])+csvR(['æ™‚é–“åˆ¥å£²ä¸Š','æ™‚é–“å¸¯ã”ã¨é›†è¨ˆ'])+csvR(['å£²ä¸Šæ˜ç´°','å…¨å–å¼•ä¸€è¦§']);}
  else if(page==='sim'){fn='ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆèª¬æ˜.csv';c='â–  ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³CSVã«å«ã¾ã‚Œã‚‹ã‚·ãƒ¼ãƒˆ\n\n'+csvR(['ã‚·ãƒ¼ãƒˆ','å†…å®¹'])+csvR(['ã‚·ãƒŸãƒ¥çµæœ','æç›Šåˆ†å²ãƒ»å®Œå£²æ™‚åˆ©ç›Š'])+csvR(['æç›Šåˆ†å²è¡¨','10%åˆ»ã¿ã®åæ”¯ä¸€è¦§'])+csvR(['åŸä¾¡å†…è¨³','ç‰ˆã”ã¨ã®åŸä¾¡'])+csvR(['ã‚¤ãƒ™ãƒ³ãƒˆçµŒè²»','çµŒè²»ä¸€è¦§']);}
  dlCSV(fn,c);showToast('ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
}
function importCSV(target){csvTarget=target;document.getElementById('csvFI').click();}
function handleCSVFile(ev){var file=ev.target.files[0];ev.target.value='';if(!file)return;var r=new FileReader();r.onload=function(e){if(csvTarget==='products')impProds(e.target.result);else if(csvTarget==='events')impEvs(e.target.result);};r.readAsText(file,'UTF-8');}
function parseCSV(text){
  var lines=text.trim().split('\n').filter(function(l){return !l.startsWith('â– ')&&!l.startsWith('â€»')&&l.trim();});
  if(lines.length<2)return[];
  var headers=lines[0].split(',').map(function(h){return h.trim().replace(/^"|"$/g,'');});
  return lines.slice(1).map(function(line){var vals=[],cur='',inQ=false;for(var i=0;i<line.length;i++){var c=line[i];if(c==='"'){inQ=!inQ;}else if(c===','&&!inQ){vals.push(cur.trim());cur='';}else cur+=c;}vals.push(cur.trim());var obj={};headers.forEach(function(h,i){obj[h]=(vals[i]||'').replace(/^"|"$/g,'');});return obj;});
}
function impProds(text){var rows=parseCSV(text);var n=0;rows.forEach(function(r){var title=r['ã‚¿ã‚¤ãƒˆãƒ«']||r['title']||'';if(!title)return;var eid=uid();var autoNum=S.p.length>0?Math.max.apply(null,S.p.map(function(x){return x.sortNum||0;}))+1:1;var sortNum=parseInt(r['No']||r['ç•ªå·']||autoNum)||autoNum;S.p.push({id:uid(),title:title,sortNum:sortNum,emoji:r['çµµæ–‡å­—']||'ğŸ“–',price:Math.max(0,parseInt(r['ã‚¤ãƒ™ãƒ³ãƒˆä¾¡æ ¼']||r['price']||0)),shopPrice:Math.max(0,parseInt(r['æ›¸åº—ä¾¡æ ¼']||0)),stock:Math.max(0,parseInt(r['åœ¨åº«']||0)),coverImg:null,costs:[],editions:[{id:eid,label:'ç¬¬1ç‰ˆ',ordered:Math.max(0,parseInt(r['ç™ºè¡Œéƒ¨æ•°(ç¬¬1ç‰ˆ)']||0))}]});n++;});save();renderPM();showToast(n+'ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');}
function impEvs(text){var rows=parseCSV(text);var n=0;rows.forEach(function(r){var name=r['ã‚¤ãƒ™ãƒ³ãƒˆå']||r['name']||'';var date=r['é–‹å‚¬æ—¥']||r['date']||'';if(!name||!date)return;S.e.push({id:uid(),name:name,date:date,expenses:[],isLocked:false,productIds:[]});n++;});save();renderEV();showToast(n+'ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ');}
function exportAnalytics(){
  var ev=S.e.find(function(e){return e.id===S.anEvId;}),evN=ev?ev.name:'ä¸æ˜';
  var sales=fSales();if(!sales.length){showToast('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  var rev=sales.reduce(function(s,x){return s+x.price*x.qty;},0),qty=sales.reduce(function(s,x){return s+x.qty;},0);
  var cu=0;sales.forEach(function(s){var p=S.p.find(function(x){return x.id===s.pid;});if(p)cu+=unitCost(p)*s.qty;});
  var exp=(ev&&ev.expenses||[]).reduce(function(s,e){return s+e.amount;},0);
  var c='â–  ã‚¤ãƒ™ãƒ³ãƒˆã‚µãƒãƒªãƒ¼\n'+csvR(['ã‚¤ãƒ™ãƒ³ãƒˆå','é–‹å‚¬æ—¥','ç·å£²ä¸Š','ç·é ’å¸ƒæ•°','ç´”åˆ©ç›Š(åŸä¾¡å·®å¼•)','å®Ÿè³ªåæ”¯(åŸä¾¡+çµŒè²»)','ç·çµŒè²»','åŸä¾¡åˆè¨ˆ']);
  c+=csvR([evN,ev?ev.date:'',rev,qty,Math.round(rev-cu),Math.round(rev-cu-exp),exp,Math.round(cu)]);
  c+='\nâ–  å•†å“åˆ¥å£²ä¸Š\n'+csvR(['å•†å“å','é ’å¸ƒæ•°','å£²ä¸Šé‡‘é¡','åŸä¾¡/éƒ¨','ç²—åˆ©','ç²—åˆ©ç‡%']);
  var byP={};sales.forEach(function(s){if(!byP[s.pid])byP[s.pid]={q:0,r:0};byP[s.pid].q+=s.qty;byP[s.pid].r+=s.price*s.qty;});
  Object.entries(byP).forEach(function(e){var p=S.p.find(function(x){return x.id===e[0];}),uc=p?unitCost(p):0,gp=e[1].r-uc*e[1].q;c+=csvR([p?p.title:'ä¸æ˜',e[1].q,e[1].r,Math.round(uc),Math.round(gp),e[1].r>0?Math.round(gp/e[1].r*100):'0']);});
  c+='\nâ–  æ™‚é–“åˆ¥å£²ä¸Š\n'+csvR(['æ™‚é–“','å£²ä¸Šé‡‘é¡','é ’å¸ƒæ•°']);
  var bh={};sales.forEach(function(s){var h=new Date(s.ts).getHours();if(!bh[h])bh[h]={m:0,c:0};bh[h].m+=s.price*s.qty;bh[h].c+=s.qty;});
  Object.entries(bh).sort(function(a,b){return +a[0]-+b[0];}).forEach(function(e){c+=csvR([e[0]+'æ™‚',e[1].m,e[1].c]);});
  c+='\nâ–  å£²ä¸Šæ˜ç´°\n'+csvR(['æ—¥æ™‚','å•†å“å','æ•°é‡','å˜ä¾¡','åˆè¨ˆ']);
  sales.forEach(function(s){var p=S.p.find(function(x){return x.id===s.pid;}),d=new Date(s.ts);c+=csvR([d.toLocaleString('ja-JP'),p?p.title:'ä¸æ˜',s.qty,s.price,s.price*s.qty]);});
  dlCSV('åˆ†æ_'+evN+'_'+new Date().toLocaleDateString('ja-JP').replace(/\//g,'-')+'.csv',c);showToast('ğŸ“¤ åˆ†æCSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸ');
}
function exportSim(){
  var p=S.p[S.simIdx];if(!p){showToast('å•†å“ãŒã‚ã‚Šã¾ã›ã‚“');return;}
  var sp=gSV(p.id,'price',p.price),so=totOrd(p),tc=totCost(p);
  var ev=S.e.find(function(e){return e.id===S.simEvId;}),et=(ev&&ev.expenses||[]).reduce(function(s,e){return s+e.amount;},0);
  var beS=sp>0&&tc>0?Math.ceil(tc/sp):'-',beR=sp>0&&(tc+et)>0?Math.ceil((tc+et)/sp):'-';
  var c='â–  ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ\n'+csvR(['å•†å“å','è²©å£²ä¾¡æ ¼(ã‚·ãƒŸãƒ¥)','ç™ºè¡Œéƒ¨æ•°','åˆ¶ä½œè²»åˆè¨ˆ','ã‚¤ãƒ™ãƒ³ãƒˆçµŒè²»','æç›Šåˆ†å²(åŸä¾¡ã®ã¿)éƒ¨','æç›Šåˆ†å²(çµŒè²»è¾¼ã¿)éƒ¨','å®Œå£²æ™‚åˆ©ç›Š(åŸä¾¡ã®ã¿)','å®Œå£²æ™‚åˆ©ç›Š(çµŒè²»è¾¼ã¿)']);
  c+=csvR([p.title,sp,so,tc,et,beS,beR,sp*so-tc,sp*so-tc-et]);
  c+='\nâ–  æç›Šåˆ†å²è¡¨ (10%åˆ»ã¿)\n'+csvR(['é ’å¸ƒç‡','éƒ¨æ•°','å£²ä¸Š','ã‚³ã‚¹ãƒˆ(åŸä¾¡ã®ã¿)','ã‚³ã‚¹ãƒˆ(çµŒè²»è¾¼ã¿)','åˆ©ç›Š(åŸä¾¡ã®ã¿)','åæ”¯(çµŒè²»è¾¼ã¿)']);
  for(var pct=10;pct<=100;pct+=10){var q=Math.round(so*pct/100),rev=sp*q;c+=csvR([pct+'%',q,rev,tc,tc+et,rev-tc,rev-tc-et]);}
  c+='\nâ–  åŸä¾¡å†…è¨³\n'+csvR(['é …ç›®å','åˆè¨ˆé‡‘é¡'].concat((p.editions||[]).map(function(e){return e.label;})));
  (p.costs||[]).forEach(function(cost){c+=csvR([cost.name,cost.amount].concat((p.editions||[]).map(function(e){return cost.perEdition&&cost.perEdition[e.id]!=null?cost.perEdition[e.id]:'';})));});
  c+='\nâ–  ç™ºè¡Œç‰ˆæ•°\n'+csvR(['ç‰ˆ','éƒ¨æ•°','åŸä¾¡åˆè¨ˆ','åŸä¾¡/éƒ¨']);
  (p.editions||[]).forEach(function(e){var ec=(p.costs||[]).reduce(function(s,c){return s+(c.perEdition&&c.perEdition[e.id]?c.perEdition[e.id]:0);},0);c+=csvR([e.label,e.ordered,ec,e.ordered>0?Math.round(ec/e.ordered):'âˆ’']);});
  if(ev){c+='\nâ–  ã‚¤ãƒ™ãƒ³ãƒˆçµŒè²»\n'+csvR(['é …ç›®','é‡‘é¡']);(ev.expenses||[]).forEach(function(e){c+=csvR([e.name,e.amount]);});}
  dlCSV('ã‚·ãƒŸãƒ¥_'+p.title+'_'+new Date().toLocaleDateString('ja-JP').replace(/\//g,'-')+'.csv',c);showToast('ğŸ“¤ ã‚·ãƒŸãƒ¥CSVã‚’å‡ºåŠ›ã—ã¾ã—ãŸ');
}

// ================================================================ SUPABASE AUTH
var SUPABASE_URL='https://kfxxjbutoneikijplwqe.supabase.co';
var SUPABASE_ANON_KEY='sb_publishable_9Hffx1h23UTuiKWAlc5L_g_OsjV0Eg_';
var sbClient=null,currentUser=null,authTab='login';

function initSupabase(){
  try{sbClient=window.supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);return true;}
  catch(e){console.warn('Supabase init failed:',e.message);return false;}
}
function switchAuthTab(tab){
  authTab=tab;
  document.getElementById('tabLogin').style.background=tab==='login'?'var(--accent)':'transparent';
  document.getElementById('tabLogin').style.color=tab==='login'?'#fff':'var(--text2)';
  document.getElementById('tabSignup').style.background=tab==='signup'?'var(--accent)':'transparent';
  document.getElementById('tabSignup').style.color=tab==='signup'?'#fff':'var(--text2)';
  document.getElementById('authSubmitBtn').textContent=tab==='login'?'ãƒ­ã‚°ã‚¤ãƒ³':'ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ';
  document.getElementById('forgotArea').style.display=tab==='login'?'block':'none';
  document.getElementById('loginErr').style.display='none';
}
async function loginWithGoogle(){
  if(!sbClient){showAuthErr('Supabaseã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚');return;}
  var r=await sbClient.auth.signInWithOAuth({provider:'google',options:{redirectTo:window.location.href}});
  if(r.error)showAuthErr(r.error.message);
}
async function submitAuth(){
  if(!sbClient){showAuthErr('Supabaseã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚');return;}
  var email=document.getElementById('authEmail').value.trim();
  var pass=document.getElementById('authPass').value;
  if(!email||!pass){showAuthErr('ãƒ¡ãƒ¼ãƒ«ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  document.getElementById('authSubmitBtn').textContent='å‡¦ç†ä¸­â€¦';
  document.getElementById('authSubmitBtn').disabled=true;
  var result=authTab==='login'
    ?await sbClient.auth.signInWithPassword({email:email,password:pass})
    :await sbClient.auth.signUp({email:email,password:pass});
  document.getElementById('authSubmitBtn').disabled=false;
  switchAuthTab(authTab);
  if(result.error){showAuthErr(result.error.message);return;}
  if(authTab==='signup'&&!result.data.session){showAuthErr('ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚Šã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚');return;}
  if(result.data.session)onLogin(result.data.session.user);
}
async function resetPassword(){
  var email=document.getElementById('authEmail').value.trim();
  if(!email){showAuthErr('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');return;}
  var r=await sbClient.auth.resetPasswordForEmail(email,{redirectTo:window.location.href});
  if(r.error)showAuthErr(r.error.message);else showAuthErr('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚Šã¾ã—ãŸ');
}
function showAuthErr(msg){var el=document.getElementById('loginErr');el.textContent=msg;el.style.display='block';}
function onLogin(user){
  currentUser=user;
  // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’éš ã—ã€ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚’è¡¨ç¤º
  document.getElementById('loginScreen').classList.remove('show');
  document.getElementById('mainApp').style.display='block';
  document.getElementById('userBtn').title=user.email||'ãƒ­ã‚°ã‚¤ãƒ³ä¸­';
  var key='djp_v4_'+user.id;
  localStorage.setItem('djp_user_key',key);
  loadData(key);
  applyTheme();
  renderPage();
  showToast('âœ… ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ: '+(user.email||'Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆ'));
}
function applyTheme(){if(S.theme==='light'){document.body.className='light';document.getElementById('themeBtn').textContent='ğŸŒ™';}else{document.body.className='';document.getElementById('themeBtn').textContent='â˜€ï¸';}}
function showUserMenu(){
  var user=currentUser;if(!user)return;
  openM('<div class="mtit">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>'
    +'<div style="text-align:center;padding:10px 0;"><div style="font-size:13px;color:var(--text2);margin-bottom:4px;">ãƒ­ã‚°ã‚¤ãƒ³ä¸­</div><div style="font-size:14px;font-weight:700;">'+(user.email||'Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆ')+'</div></div>'
    +'<div class="mact" style="flex-direction:column;gap:8px;"><button class="btn bd bfull" onclick="doLogout()">ğŸšª ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button><button class="btn bg bfull" onclick="closeM()">é–‰ã˜ã‚‹</button></div>');
}
async function doLogout(){
  if(sbClient)await sbClient.auth.signOut();
  currentUser=null;localStorage.removeItem('djp_user_key');
  document.getElementById('mainApp').style.display='none';
  document.getElementById('loginScreen').classList.add('show');
  closeM();showToast('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
}
function toggleTheme(){S.theme=S.theme==='dark'?'light':'dark';applyTheme();save();}

// ================================================================ INIT
// ================================================================ MODES
var appMode='local'; // 'guest' | 'local' | 'cloud'

function startGuestMode(){
  appMode='guest';
  S.p=[];S.e=[];S.s=[];
  initSample();
  applyTheme();
  document.getElementById('loginScreen').classList.remove('show');
  document.getElementById('mainApp').style.display='block';
  renderPage();
  showToast('ã‚²ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã—ãŸï¼ˆãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ï¼‰');
}

function startLocalSavedMode(){
  appMode='local';
  var lsKey='djp_v4_local';
  localStorage.setItem('djp_user_key',lsKey);
  loadData(lsKey);
  applyTheme();
  document.getElementById('loginScreen').classList.remove('show');
  document.getElementById('mainApp').style.display='block';
  renderPage();
  showToast('ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ã—ã¾ã—ãŸ');
}

function startLocalMode(){
  appMode='local';
  var lsKey=localStorage.getItem('djp_user_key')||'djp_v4_local';
  loadData(lsKey);
  applyTheme();
  document.getElementById('loginScreen').classList.remove('show');
  document.getElementById('mainApp').style.display='block';
  renderPage();
}

// Supabase ã‚’å‹•çš„ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
function loadSupabaseJS(cb){
  if(window.supabase){cb(true);return;}
  var s=document.createElement('script');
  s.src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
  s.onload=function(){cb(true);};
  s.onerror=function(){cb(false);};
  document.head.appendChild(s);
}

function tryLoginWithGoogle(){
  var btn=document.getElementById('googleLoginBtn');
  if(btn){btn.textContent='èª­è¾¼ä¸­â€¦';btn.disabled=true;}
  loadSupabaseJS(function(ok){
    if(btn){btn.textContent='Googleã§ãƒ­ã‚°ã‚¤ãƒ³';btn.disabled=false;}
    if(!ok){showAuthErr('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå¿…è¦ã§ã™');return;}
    if(!initSupabase()){showAuthErr('Supabaseã®è¨­å®šãŒå¿…è¦ã§ã™');return;}
    loginWithGoogle();
  });
}

function trySubmitAuth(){
  loadSupabaseJS(function(ok){
    if(!ok){showAuthErr('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå¿…è¦ã§ã™');return;}
    if(!initSupabase()){showAuthErr('Supabaseã®è¨­å®šãŒå¿…è¦ã§ã™');return;}
    submitAuth();
  });
}

function tryResetPassword(){
  loadSupabaseJS(function(ok){
    if(!ok){showAuthErr('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå¿…è¦ã§ã™');return;}
    if(!initSupabase()){showAuthErr('Supabaseã®è¨­å®šãŒå¿…è¦ã§ã™');return;}
    resetPassword();
  });
}

// ================================================================ INIT
window.addEventListener('online',function(){var d=document.getElementById('sdot');if(d)d.classList.remove('off');});
window.addEventListener('offline',function(){var d=document.getElementById('sdot');if(d)d.classList.add('off');});

(function initApp(){
  // æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚­ãƒ¼ãŒã‚ã‚Œã°ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å³èµ·å‹•
  var savedKey=localStorage.getItem('djp_user_key');
  if(savedKey){
    startLocalMode();
    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã‚¯ãƒ©ã‚¦ãƒ‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
    if(savedKey!=='djp_v4_local'&&savedKey!=='djp_v4'){
      loadSupabaseJS(function(ok){
        if(!ok||!initSupabase())return;
        sbClient.auth.getSession().then(function(res){
          var sess=res.data&&res.data.session;
          if(sess&&sess.user){currentUser=sess.user;appMode='cloud';var btn=document.getElementById('userBtn');if(btn)btn.title=sess.user.email||'ãƒ­ã‚°ã‚¤ãƒ³ä¸­';}
        }).catch(function(){});
        sbClient.auth.onAuthStateChange(function(event,sess){
          if(event==='SIGNED_IN'&&sess&&sess.user){onLogin(sess.user);}
          if(event==='SIGNED_OUT'){currentUser=null;appMode='local';}
        });
      });
    }
    return;
  }
  // åˆå›èµ·å‹•: ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
  document.getElementById('loginScreen').classList.add('show');
})();
</script>

<script>
if('serviceWorker' in navigator){
  window.addEventListener('load',function(){
    navigator.serviceWorker.register('./sw.js').catch(function(){});
  });
}
</script>
</body>
</html>
